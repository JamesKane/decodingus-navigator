# Atmosphere Lexicon Design

To support the "Atmosphere" integration within the AT Protocol (Bluesky) ecosystem, we define a specific Lexicon (schema) for Genomic Data. This allows `decodingus` to interact with the global network of Personal Data Stores (PDS) using standard XRPC methods, effectively turning genomic metadata into a portable, user-owned record type.

## Namespace: `com.decodingus.atmosphere`

This namespace covers the genomic operational data generated by BGS nodes and owned by Citizens.

---

### 1. Workspace Record (`com.decodingus.atmosphere.workspace`)

This record serves as the root container for a Researcher's PDS, aggregating biosample records and defined research projects.

**NSID:** `com.decodingus.atmosphere.workspace`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.workspace",
  "defs": {
    "main": {
      "type": "record",
      "description": "The root container for a Researcher's workspace, holding a pool of biosamples and defined projects.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["samples", "projects"],
        "properties": {
          "samples": {
            "type": "array",
            "description": "The pool of all biosamples managed in this workspace.",
            "items": {
              "type": "ref",
              "ref": "#biosample"
            }
          },
          "projects": {
            "type": "array",
            "description": "Research projects grouping specific biosamples.",
            "items": {
              "type": "ref",
              "ref": "#project"
            }
          }
        }
      }
    },
    "biosample": {
      "type": "ref",
      "ref": "com.decodingus.atmosphere.biosample#main"
    },
    "project": {
      "type": "ref",
      "ref": "com.decodingus.atmosphere.project#main"
    }
  }
}
```

---

### 2. Biosample Record (`com.decodingus.atmosphere.biosample`)

This record represents a single biological sample processed by a BGS node. It maps directly to the `ExternalBiosampleRequest` used in the MVP REST API, but with enhanced detail.

**NSID:** `com.decodingus.atmosphere.biosample`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.biosample",
  "defs": {
    "main": {
      "type": "record",
      "description": "A record representing a biological sample and its associated sequencing metadata.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["sampleAccession", "donorIdentifier", "centerName", "sequenceData", "citizenDid", "atUri"],
        "properties": {
          "sampleAccession": {
        "type": "string",
        "description": "Native identifier provided by the client for the biosample."
      },
      "donorIdentifier": {
        "type": "string",
        "description": "Identifier for the specimen donor within the user's context."
      },
      "citizenDid": {
        "type": "string",
        "description": "The Decentralized Identifier (DID) of the citizen/researcher who owns this biosample record."
      },
      "atUri": {
        "type": "string",
        "description": "The AT URI (at://did/collection/rkey) of this biosample record, assigned by the PDS. This uniquely identifies the record within the AT Protocol network."
      },
      "description": {
        "type": "string",
        "description": "Human-readable description of the sample."
          },
          "centerName": {
            "type": "string",
            "description": "The name of the Sequencing Center or BGS Node."
          },
          "sex": {
            "type": "string",
            "description": "Biological sex of the donor.",
            "knownValues": ["Male", "Female", "Other", "Unknown"]
          },
          "sequenceData": {
            "type": "array",
            "description": "List of sequencing data entries, allowing for multiple alignments (e.g., GRCh38, chm13v2.0) or runs.",
            "items": {
              "type": "ref",
              "ref": "#sequenceData"
            }
          },
          "haplogroups": {
            "type": "ref",
            "ref": "#haplogroupAssignments",
            "description": "Y-DNA and mtDNA haplogroup assignments derived from the sequencing data."
          },
          "createdAt": {
            "type": "string",
            "format": "datetime"
          }
        }
      }
    },
    "haplogroupAssignments": {
      "type": "object",
      "description": "Container for paternal (Y-DNA) and maternal (mtDNA) haplogroup classifications.",
      "properties": {
        "yDna": {
          "type": "ref",
          "ref": "#haplogroupResult",
          "description": "The predicted Y-chromosome haplogroup (Paternal)."
        },
        "mtDna": {
          "type": "ref",
          "ref": "#haplogroupResult",
          "description": "The predicted Mitochondrial haplogroup (Maternal)."
        }
      }
    },
    "haplogroupResult": {
      "type": "object",
      "description": "Detailed scoring and classification result for a haplogroup.",
      "required": ["haplogroupName", "score"],
      "properties": {
        "haplogroupName": {
          "type": "string",
          "description": "The assigned haplogroup nomenclature (e.g., R-M269, H1a)."
        },
        "score": {
          "type": "float",
          "description": "Confidence score of the assignment."
        },
        "matchingSnps": {
          "type": "integer",
          "description": "Count of SNPs matching the defining mutations for this haplogroup."
        },
        "mismatchingSnps": {
          "type": "integer",
          "description": "Count of SNPs that contradict the assignment."
        },
        "ancestralMatches": {
          "type": "integer",
          "description": "Count of ancestral state matches."
        },
        "treeDepth": {
          "type": "integer",
          "description": "The depth of the assigned node in the phylogenetic tree."
        },
        "lineagePath": {
          "type": "array",
          "description": "The path from root to the assigned haplogroup (e.g., A -> ... -> R -> ... -> R-M269).",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "sequenceData": {
      "type": "object",
      "description": "Raw sequencing run details and associated alignments.",
      "required": ["platformName", "testType", "files"],
      "properties": {
        "platformName": {
          "type": "string",
          "description": "Sequencing platform (e.g., ILLUMINA, PACBIO)."
        },
        "instrumentModel": {
          "type": "string",
          "description": "Specific instrument model (e.g., NovaSeq 6000)."
        },
        "testType": {
          "type": "string",
          "description": "Type of test (e.g., WGS, EXOME)."
        },
        "libraryLayout": {
          "type": "string",
          "description": "Paired-end or Single-end.",
          "knownValues": ["PAIRED", "SINGLE"]
        },
        "totalReads": {
          "type": "integer",
          "description": "Total number of reads."
        },
        "readLength": {
          "type": "integer",
          "description": "Average read length."
        },
        "meanInsertSize": {
          "type": "float",
          "description": "Mean insert size of the library."
        },
        "files": {
          "type": "array",
          "description": "Raw data files (e.g., FASTQs).",
          "items": {
            "type": "ref",
            "ref": "#fileInfo"
          }
        },
        "alignments": {
          "type": "array",
          "description": "List of alignments performed on this sequencing run.",
          "items": {
            "type": "ref",
            "ref": "#alignmentData"
          }
        }
      }
    },
    "alignmentData": {
      "type": "object",
      "description": "Details of a specific alignment (e.g., to GRCh38).",
      "required": ["referenceBuild", "aligner", "metrics"],
      "properties": {
        "referenceBuild": {
          "type": "string",
          "description": "Reference genome build (e.g., hg38, GRCh38)."
        },
        "aligner": {
          "type": "string",
          "description": "Tool used for alignment (e.g., BWA-MEM)."
        },
        "files": {
          "type": "array",
          "description": "Aligned data files (e.g., BAM, CRAM, VCF).",
          "items": {
            "type": "ref",
            "ref": "#fileInfo"
          }
        },
        "metrics": {
          "type": "ref",
          "ref": "#alignmentMetrics"
        }
      }
    },
    "alignmentMetrics": {
      "type": "object",
      "description": "Quality control metrics for the alignment.",
      "properties": {
        "genomeTerritory": {
          "type": "integer",
          "description": "The total number of bases in the reference genome territory."
        },
        "meanCoverage": {
          "type": "float",
          "description": "The mean coverage across the genome territory."
        },
        "medianCoverage": {
          "type": "float"
        },
        "sdCoverage": {
          "type": "float",
          "description": "Standard deviation of coverage."
        },
        "pctExcDupe": {
           "type": "float",
           "description": "Percentage of reads excluded due to duplication."
        },
        "pctExcMapq": {
           "type": "float",
           "description": "Percentage of reads excluded due to low mapping quality."
        },
        "pct10x": {
           "type": "float",
           "description": "Percentage of genome with at least 10x coverage."
        },
        "pct20x": {
           "type": "float",
           "description": "Percentage of genome with at least 20x coverage."
        },
        "pct30x": {
           "type": "float",
           "description": "Percentage of genome with at least 30x coverage."
        },
        "hetSnpSensitivity": {
           "type": "float",
           "description": "Sensitivity for detecting heterozygous SNPs."
        },
        "contigs": {
          "type": "array",
          "description": "Per-contig coverage statistics.",
          "items": {
             "type": "ref",
             "ref": "#contigMetrics"
          }
        }
      }
    },
    "contigMetrics": {
      "type": "object",
      "description": "Coverage analysis for a specific contig (chromosome).",
      "required": ["contigName", "callableBases"],
      "properties": {
        "contigName": {
          "type": "string",
          "description": "Name of the contig (e.g., chr1, 1)."
        },
        "callableBases": {
          "type": "integer",
          "description": "Number of bases deemed callable."
        },
        "meanCoverage": {
          "type": "float"
        },
        "poorMappingQuality": {
          "type": "integer",
          "description": "Number of bases with poor mapping quality."
        },
        "lowCoverage": {
           "type": "integer"
        },
        "noCoverage": {
           "type": "integer"
        }
      }
    },
    "fileInfo": {
      "type": "object",
      "description": "Metadata about a specific data file (FASTQ, BAM, etc.).",
      "required": ["fileName", "fileFormat", "location"],
      "properties": {
        "fileName": {
          "type": "string"
        },
        "fileSizeBytes": {
          "type": "integer"
        },
        "fileFormat": {
          "type": "string",
          "knownValues": ["FASTQ", "BAM", "CRAM", "VCF"]
        },
        "checksum": {
            "type": "string",
            "description": "SHA-256 or similar checksum."
        },
        "location": {
          "type": "string",
          "format": "uri",
          "description": "The URI where the file is stored (e.g., s3://..., ipfs://...)."
        }
      }
    }
  }
}
```

---

### 3. Project Record (`com.decodingus.atmosphere.project`)

This record defines a research project that aggregates multiple biosamples within a Researcher's PDS.

**NSID:** `com.decodingus.atmosphere.project`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.project",
  "defs": {
    "main": {
      "type": "record",
      "description": "A genealogy or research project that aggregates multiple biosamples.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["projectName", "administrator", "members", "atUri"],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI (at://did/collection/rkey) of this project record, assigned by the PDS."
          },
          "projectName": {
            "type": "string",
            "description": "Name of the project (e.g., 'Smith Surname Project')."
          },
          "description": {
            "type": "string",
            "description": "Goals and scope of the research."
          },
          "administrator": {
            "type": "string",
            "description": "The DID or identifier of the researcher managing this project."
          },
          "members": {
            "type": "array",
            "description": "List of biosamples associated with this project. References are relative RKeys within the same PDS.",
            "items": {
               "type": "string",
               "description": "RKey of a biosample record in this PDS."
            }
          }
        }
      }
    }
  }
}
```

## Integration Strategy

In the "Atmosphere" model, this Lexicon defines the data structures for decentralized, user-owned genomic records:

1.  **MVP (Current):** The BGS Node (Rust) constructs a JSON payload matching the `ExternalBiosampleRequest` (a simplified subset of this Lexicon) and pushes it to `decodingus` via REST.
2.  **Phase 2 (Hybrid - Kafka):** The BGS Node uses this Lexicon structure (or a derived internal representation) to send messages to Kafka. `decodingus` consumes from Kafka and processes a compatible subset.
3.  **Phase 3 (Full Atmosphere - AppView):**
    *   The Researcher's Edge App (Java) or the BGS Node (authorized by the user) constructs records fully compliant with this Lexicon.
    *   These records are written directly to the User's PDS.
    *   `decodingus` (acting as an AppView) subscribes to the ATP Firehose, ingesting these records and indexing them.

## Mapping to `decodingus` Backend (Phase 3 Considerations)

To fully leverage this Lexicon, `decodingus` will need to evolve its internal data model and services:

*   **`Biosample`:** Fields like `description`, `centerName`, `sex`, `sampleAccession`, `donorIdentifier` map directly. `createdAt` will come from the record metadata.
*   **`SequenceLibrary`:** `platformName`, `instrumentModel` (new), `testType`, `libraryLayout` (new), `totalReads` (new - `reads`), `readLength`, `meanInsertSize` (new - `insertSize`).
*   **`SequenceFile`:** `fileInfo` maps directly (`fileName`, `fileSizeBytes`, `fileFormat`, `checksum`, `location`).
*   **`Alignment` (New Entity):** `alignmentData` will likely require new tables/models to store `referenceBuild`, `aligner`, and the associated `files`.
*   **`AlignmentMetrics` (New Entity):** `alignmentMetrics` will be a significant addition, requiring new tables and potentially a dedicated service to store and query these detailed QC statistics.
*   **`Haplogroups` (Enhanced):** The detailed `haplogroupResult` (score, SNPs, lineage path) can replace or enrich our existing `BiosampleOriginalHaplogroup` model, allowing us to store the *evidence* for haplogroup calls.
*   **`Project` (New Entity):** Will require new tables (`projects`, `project_members`) and services.
*   **`Workspace`:** This `record` might not have a direct mapping in `decodingus` as it's a PDS-level container, but its `samples` and `projects` references will drive our indexing.

## Lifecycle Management (AppView Logic)

As an AppView, `decodingus` subscribes to the AT Protocol Firehose to maintain a synchronized state of the genomic network.

### 1. The Firehose Event Stream
We listen for `com.atproto.sync.subscribeRepos` events containing operations for the collection `com.decodingus.atmosphere.biosample` (and potentially `com.decodingus.atmosphere.project` and `com.decodingus.atmosphere.workspace` in the future).

### 2. Event Handling Strategy

| Event Action | Description | DecodingUs Logic |
| :--- | :--- | :--- |
| **Create** | User creates a new record. | 1. Extract `citizenDid` (Repo DID) and record body.<br>2. Map Lexicon record to `ExternalBiosampleRequest` (or directly to internal models).<br>3. Invoke `ExternalBiosampleService.create` (or an equivalent AppView ingestion service).<br>4. Store the `at_uri` (e.g., `at://did.../collection/rkey`) and `at_cid` in the `biosamples` table. |
| **Update** | User modifies an existing record. | 1. Lookup `Biosample` by `at_uri`.<br>2. Compare `at_cid` to ensure strictly newer version.<br>3. Map Lexicon record to internal models.<br>4. Update mutable fields (description, metrics, file URLs, haplogroups).<br>5. Update `at_cid`. |
| **Delete** | User removes a record. | 1. Lookup `Biosample` by `at_uri`.<br>2. Perform **Soft Delete** (mark as archived/hidden).<br>3. Remove from active visualization trees.<br>*Hard deletes are avoided to preserve scientific lineage unless legally required (GDPR).* |

### 3. Schema Requirements
To support robust syncing, the internal `biosamples` table requires tracking fields:

*   **`at_uri` (String, Unique):** The canonical decentralized address of the record. Used for lookups during Update/Delete.
*   **`at_cid` (String):** The content identifier (hash) of the current version. Used for optimistic locking and preventing replay attacks/race conditions.

### 4. Example Mock Data

Below are JSON examples of how valid records would appear in the `com.decodingus.atmosphere` namespace.

#### Biosample Record (`com.decodingus.atmosphere.biosample`)

```json
{
  "$type": "com.decodingus.atmosphere.biosample",
  "sampleAccession": "BGS-UUID-98765-XYZ",
  "donorIdentifier": "Subject-001",
  "description": "Deep WGS of Proband from Smith Family Trio",
  "centerName": "DecodingUs Reference Lab",
  "sex": "Male",
  "createdAt": "2025-12-05T14:30:00Z",
  "haplogroups": {
    "yDna": {
      "haplogroupName": "R-M269",
      "score": 0.998,
      "matchingSnps": 145,
      "mismatchingSnps": 2,
      "ancestralMatches": 3000,
      "treeDepth": 25,
      "lineagePath": ["R", "R1", "R1b", "R-M269"]
    },
    "mtDna": {
      "haplogroupName": "H1a",
      "score": 0.995,
      "matchingSnps": 42,
      "mismatchingSnps": 0,
      "ancestralMatches": 800,
      "treeDepth": 18,
      "lineagePath": ["L3", "N", "R", "HV", "H", "H1", "H1a"]
    }
  },
  "sequenceData": [
    {
      "platformName": "ILLUMINA",
      "instrumentModel": "NovaSeq 6000",
      "testType": "WGS",
      "libraryLayout": "PAIRED",
      "totalReads": 850000000,
      "readLength": 150,
      "meanInsertSize": 450.0,
      "files": [
        {
          "fileName": "Sample001_R1.fastq.gz",
          "fileSizeBytes": 15000000000,
          "fileFormat": "FASTQ",
          "checksum": "sha256-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
          "location": "s3://lab-data-bucket/raw/Sample001_R1.fastq.gz"
        },
        {
          "fileName": "Sample001_R2.fastq.gz",
          "fileSizeBytes": 16000000000,
          "fileFormat": "FASTQ",
          "checksum": "sha256-d7a8fbb307d7809469ca9abcb0082e4f8d5651e46d3cdb762d02d0bf37c9e553",
          "location": "s3://lab-data-bucket/raw/Sample001_R2.fastq.gz"
        }
      ],
      "alignments": [
        {
          "referenceBuild": "GRCh38",
          "aligner": "BWA-MEM 0.7.17",
          "files": [
            {
              "fileName": "Sample001.hg38.cram",
              "fileSizeBytes": 22000000000,
              "fileFormat": "CRAM",
              "checksum": "sha256-0b7c68d2266643392788995209377460244359634270247b3618245356363834",
              "location": "s3://lab-data-bucket/aligned/Sample001.hg38.cram"
            }
          ],
          "metrics": {
            "genomeTerritory": 3100000000,
            "meanCoverage": 32.5,
            "medianCoverage": 31.0,
            "sdCoverage": 8.5,
            "pctExcDupe": 0.12,
            "pctExcMapq": 0.02,
            "pct10x": 0.98,
            "pct20x": 0.95,
            "pct30x": 0.85,
            "hetSnpSensitivity": 0.992,
            "contigs": [
              {
                "contigName": "chr1",
                "callableBases": 240000000,
                "meanCoverage": 33.1,
                "poorMappingQuality": 15000,
                "lowCoverage": 5000,
                "noCoverage": 100
              },
               {
                "contigName": "chrY",
                "callableBases": 25000000,
                "meanCoverage": 16.5, 
                "poorMappingQuality": 50000,
                "lowCoverage": 2000,
                "noCoverage": 500
              }
            ]
          }
        }
      ]
    }
  ]
}
```

#### Project Record (`com.decodingus.atmosphere.project`)

```json
{
  "$type": "com.decodingus.atmosphere.project",
  "projectName": "Smith Surname Project",
  "description": "A collaborative effort to trace the paternal lineage of the Smith family originating from Yorkshire.",
  "administrator": "did:plc:alice123456",
  "members": [
    "at://did:plc:alice123456/com.decodingus.atmosphere.biosample/rkey-sample-001",
    "at://did:plc:bob987654/com.decodingus.atmosphere.biosample/rkey-sample-002",
    "at://did:plc:charlie111/com.decodingus.atmosphere.biosample/rkey-sample-003"
  ]
}
```