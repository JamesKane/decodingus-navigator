# Atmosphere Lexicon Design

To support the "Atmosphere" integration within the AT Protocol (Bluesky) ecosystem, we define a specific Lexicon (
schema) for Genomic Data. This allows `decodingus` to interact with the global network of Personal Data Stores (PDS)
using standard XRPC methods, effectively turning genomic metadata into a portable, user-owned record type.

## Design Principles

1. **Granular Records**: Each logical entity (biosample, sequence run, alignment) is a first-class record with its own
   AT URI. This enables fine-grained CRUD operations without cascading changes.
2. **Parent-Child References**: Child records reference their parents via AT URI, enabling relationship traversal and
   cascade operations.
3. **Version Tracking**: Records include metadata for change detection and conflict resolution.
4. **Soft Deletes**: Deletions are non-destructive to preserve scientific lineage.
5. **Consent-Driven Sharing**: Matching and comparison features require explicit consent records.
6. **Edge Computing / Metadata Only**: Raw genomic data (BAM, CRAM, VCF, FASTQ, genotype files) is **never** transmitted
   to DecodingUs. All analysis is performed locally in the Navigator Workbench. Only computed summaries and metadata
   flow through the PDS to the AppView.

### What Flows to DecodingUs (via PDS)

| Data Type                | Purpose                                      | Example Fields                                                                                                                       |
|:-------------------------|:---------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------|
| Haplogroup assignments   | Tree placement & refinement                  | `haplogroupName`, `score`, `lineagePath`                                                                                             |
| Private Y-DNA/mtDNA SNPs | Branch discovery consensus                   | `privateVariants` array                                                                                                              |
| STR marker values        | Ancestral reconstruction & TMRCA             | `strProfile.markers`                                                                                                                 |
| Coverage/quality metrics | Sample characterization                      | `alignmentMetrics` summary                                                                                                           |
| Ancestry percentages     | Population context & IBD match introductions | `populationBreakdown.components` (33 sub-continental populations), `superPopulationSummary` (9 continental groups), `pcaCoordinates` |
| File metadata            | Provenance tracking                          | `fileInfo` (name, checksum, size - NOT content)                                                                                      |

### What NEVER Flows to DecodingUs

| Data Type           | Stays Where     | Notes                                  |
|:--------------------|:----------------|:---------------------------------------|
| BAM/CRAM files      | Local workbench | Aligned sequences                      |
| VCF files           | Local workbench | Only private SNPs shared, not full VCF |
| FASTQ files         | Local workbench | Raw reads                              |
| Genotype chip files | Local workbench | Ancestry computed locally              |
| IBD segments        | Local workbench | Only confirmed match metadata shared   |

**Note on `fileInfo` records**: The `location` field in `fileInfo` is for the user's own reference (local paths,
personal cloud storage). DecodingUs does NOT access these locations. The field exists so users can track where their
files are stored for their own analysis workflows.

## Namespace: `com.decodingus.atmosphere`

This namespace covers the genomic operational data generated by BGS nodes and owned by Citizens.

---

## Common Definitions

### Record Metadata (`com.decodingus.atmosphere.defs`)

Shared type definitions used across multiple record types.

**NSID:** `com.decodingus.atmosphere.defs`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.defs",
  "defs": {
    "recordMeta": {
      "type": "object",
      "description": "Metadata for tracking changes and enabling efficient sync.",
      "required": [
        "version",
        "createdAt"
      ],
      "properties": {
        "version": {
          "type": "integer",
          "description": "Monotonically increasing version number for this record. Incremented on each update."
        },
        "createdAt": {
          "type": "string",
          "format": "datetime",
          "description": "Timestamp when this record was first created."
        },
        "updatedAt": {
          "type": "string",
          "format": "datetime",
          "description": "Timestamp of the most recent update."
        },
        "lastModifiedField": {
          "type": "string",
          "description": "Hint about what field changed in the last update (e.g., 'haplogroups.yDna', 'description')."
        }
      }
    },
    "fileInfo": {
      "type": "object",
      "description": "Metadata about a data file for provenance tracking. NOTE: This is metadata ONLY - DecodingUs never accesses the actual file content. Files remain on the user's local system or personal storage.",
      "required": [
        "fileName",
        "fileFormat"
      ],
      "properties": {
        "fileName": {
          "type": "string"
        },
        "fileSizeBytes": {
          "type": "integer"
        },
        "fileFormat": {
          "type": "string",
          "knownValues": [
            "FASTQ",
            "BAM",
            "CRAM",
            "VCF",
            "GVCF",
            "BED",
            "23ANDME",
            "ANCESTRY",
            "FTDNA"
          ]
        },
        "checksum": {
          "type": "string",
          "description": "SHA-256 or similar checksum for data integrity verification."
        },
        "checksumAlgorithm": {
          "type": "string",
          "description": "Algorithm used for checksum (e.g., 'SHA-256', 'MD5').",
          "knownValues": [
            "SHA-256",
            "MD5",
            "CRC32"
          ]
        },
        "location": {
          "type": "string",
          "format": "uri",
          "description": "User's personal reference to file location (local path, personal cloud). DecodingUs does NOT access this URI."
        }
      }
    },
    "haplogroupResult": {
      "type": "object",
      "description": "Detailed scoring and classification result for a haplogroup.",
      "required": [
        "haplogroupName",
        "score"
      ],
      "properties": {
        "haplogroupName": {
          "type": "string",
          "description": "The assigned haplogroup nomenclature (e.g., R-M269, H1a)."
        },
        "score": {
          "type": "float",
          "description": "Confidence score of the assignment."
        },
        "matchingSnps": {
          "type": "integer",
          "description": "Count of SNPs matching the defining mutations for this haplogroup."
        },
        "mismatchingSnps": {
          "type": "integer",
          "description": "Count of SNPs that contradict the assignment (potential private variants)."
        },
        "ancestralMatches": {
          "type": "integer",
          "description": "Count of ancestral state matches."
        },
        "treeDepth": {
          "type": "integer",
          "description": "The depth of the assigned node in the phylogenetic tree."
        },
        "lineagePath": {
          "type": "array",
          "description": "The path from root to the assigned haplogroup (e.g., A -> ... -> R -> ... -> R-M269).",
          "items": {
            "type": "string"
          }
        },
        "privateVariants": {
          "type": "ref",
          "ref": "#privateVariantData",
          "description": "Detailed private variant calls for haplogroup discovery (optional)."
        }
      }
    },
    "privateVariantData": {
      "type": "object",
      "description": "Detailed private variant calls that extend beyond the terminal haplogroup.",
      "properties": {
        "variants": {
          "type": "array",
          "description": "List of private (novel) variant calls.",
          "items": {
            "type": "ref",
            "ref": "#variantCall"
          }
        },
        "analysisVersion": {
          "type": "string",
          "description": "Version of the haplogroup analysis pipeline that identified these variants."
        },
        "referenceTree": {
          "type": "string",
          "description": "The haplogroup tree version used (e.g., 'ISOGG-2024', 'PhyloTree-17')."
        }
      }
    },
    "variantCall": {
      "type": "object",
      "description": "A single variant call representing a mutation.",
      "required": [
        "contigAccession",
        "position",
        "referenceAllele",
        "alternateAllele"
      ],
      "properties": {
        "contigAccession": {
          "type": "string",
          "description": "GenBank accession for the contig (e.g., 'NC_000024.10' for chrY)."
        },
        "position": {
          "type": "integer",
          "description": "1-based position on the contig."
        },
        "referenceAllele": {
          "type": "string",
          "description": "Reference allele."
        },
        "alternateAllele": {
          "type": "string",
          "description": "Alternate (mutant) allele."
        },
        "rsId": {
          "type": "string",
          "description": "dbSNP rsID if known (e.g., 'rs123456')."
        },
        "variantName": {
          "type": "string",
          "description": "Common name if known (e.g., 'M269', 'L21')."
        },
        "genotype": {
          "type": "string",
          "description": "Called genotype (e.g., 'A', 'T', 'het')."
        },
        "quality": {
          "type": "float",
          "description": "Variant call quality score."
        },
        "depth": {
          "type": "integer",
          "description": "Read depth at this position."
        }
      }
    },
    "haplogroupAssignments": {
      "type": "object",
      "description": "Container for paternal (Y-DNA) and maternal (mtDNA) haplogroup classifications.",
      "properties": {
        "yDna": {
          "type": "ref",
          "ref": "#haplogroupResult",
          "description": "The predicted Y-chromosome haplogroup (Paternal)."
        },
        "mtDna": {
          "type": "ref",
          "ref": "#haplogroupResult",
          "description": "The predicted Mitochondrial haplogroup (Maternal)."
        }
      }
    },
    "alignmentMetrics": {
      "type": "object",
      "description": "Quality control metrics for the alignment.",
      "properties": {
        "genomeTerritory": {
          "type": "integer",
          "description": "The total number of bases in the reference genome territory."
        },
        "meanCoverage": {
          "type": "float",
          "description": "The mean coverage across the genome territory."
        },
        "medianCoverage": {
          "type": "float"
        },
        "sdCoverage": {
          "type": "float",
          "description": "Standard deviation of coverage."
        },
        "pctExcDupe": {
          "type": "float",
          "description": "Percentage of reads excluded due to duplication."
        },
        "pctExcMapq": {
          "type": "float",
          "description": "Percentage of reads excluded due to low mapping quality."
        },
        "pct10x": {
          "type": "float",
          "description": "Percentage of genome with at least 10x coverage."
        },
        "pct20x": {
          "type": "float",
          "description": "Percentage of genome with at least 20x coverage."
        },
        "pct30x": {
          "type": "float",
          "description": "Percentage of genome with at least 30x coverage."
        },
        "hetSnpSensitivity": {
          "type": "float",
          "description": "Sensitivity for detecting heterozygous SNPs."
        },
        "contigs": {
          "type": "array",
          "description": "Per-contig coverage statistics.",
          "items": {
            "type": "ref",
            "ref": "#contigMetrics"
          }
        }
      }
    },
    "contigMetrics": {
      "type": "object",
      "description": "Coverage analysis for a specific contig (chromosome).",
      "required": [
        "contigName",
        "callableBases"
      ],
      "properties": {
        "contigName": {
          "type": "string",
          "description": "Name of the contig (e.g., chr1, 1)."
        },
        "callableBases": {
          "type": "integer",
          "description": "Number of bases deemed callable."
        },
        "meanCoverage": {
          "type": "float"
        },
        "poorMappingQuality": {
          "type": "integer",
          "description": "Number of bases with poor mapping quality."
        },
        "lowCoverage": {
          "type": "integer"
        },
        "noCoverage": {
          "type": "integer"
        }
      }
    },
    "populationComponent": {
      "type": "object",
      "description": "A single ancestry component in a population breakdown. Sub-continental granularity (~33 populations from 1000 Genomes + HGDP/SGDP).",
      "required": [
        "populationCode",
        "percentage"
      ],
      "properties": {
        "populationCode": {
          "type": "string",
          "description": "Standardized population code from reference panel (e.g., 'CEU', 'YRI', 'CHB', 'GIH')."
        },
        "populationName": {
          "type": "string",
          "description": "Human-readable population name (e.g., 'Northwestern European', 'Yoruba', 'Han Chinese')."
        },
        "superPopulation": {
          "type": "string",
          "description": "Continental-level grouping for this population.",
          "knownValues": [
            "European",
            "African",
            "East Asian",
            "South Asian",
            "Americas",
            "West Asian",
            "Oceanian",
            "Central Asian",
            "Native American"
          ]
        },
        "percentage": {
          "type": "float",
          "description": "Percentage contribution (0.0-100.0)."
        },
        "confidenceInterval": {
          "type": "object",
          "description": "95% confidence interval for the percentage estimate.",
          "properties": {
            "lower": {
              "type": "float"
            },
            "upper": {
              "type": "float"
            }
          }
        },
        "rank": {
          "type": "integer",
          "description": "Rank by percentage (1 = highest). Useful for sorting display."
        }
      }
    },
    "superPopulationSummary": {
      "type": "object",
      "description": "Aggregated ancestry percentage at the continental/super-population level.",
      "required": [
        "superPopulation",
        "percentage"
      ],
      "properties": {
        "superPopulation": {
          "type": "string",
          "description": "Continental-level population grouping.",
          "knownValues": [
            "European",
            "African",
            "East Asian",
            "South Asian",
            "Americas",
            "West Asian",
            "Oceanian",
            "Central Asian",
            "Native American"
          ]
        },
        "percentage": {
          "type": "float",
          "description": "Combined percentage from all sub-populations in this group (0.0-100.0)."
        },
        "populations": {
          "type": "array",
          "description": "List of population codes contributing to this super-population.",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ancestryPanel": {
      "type": "object",
      "description": "Description of the SNP panel used for ancestry analysis.",
      "required": [
        "panelType",
        "snpCount"
      ],
      "properties": {
        "panelType": {
          "type": "string",
          "description": "Type of ancestry panel used.",
          "knownValues": [
            "aims",
            "genome-wide"
          ]
        },
        "snpCount": {
          "type": "integer",
          "description": "Number of SNPs in the panel (aims: ~5,000; genome-wide: ~500,000)."
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the panel."
        },
        "referenceVersion": {
          "type": "string",
          "description": "Version of the reference panel data (e.g., 'v1')."
        }
      }
    },
    "ibdSegment": {
      "type": "object",
      "description": "An identical-by-descent (IBD) segment shared between two samples.",
      "required": [
        "chromosome",
        "startPosition",
        "endPosition",
        "lengthCm"
      ],
      "properties": {
        "chromosome": {
          "type": "string",
          "description": "Chromosome number (e.g., '1', '22', 'X')."
        },
        "startPosition": {
          "type": "integer",
          "description": "Start position in base pairs."
        },
        "endPosition": {
          "type": "integer",
          "description": "End position in base pairs."
        },
        "lengthCm": {
          "type": "float",
          "description": "Length in centiMorgans."
        },
        "snpCount": {
          "type": "integer",
          "description": "Number of SNPs in the segment."
        },
        "isHalfIdentical": {
          "type": "boolean",
          "description": "True if half-identical (one allele matches), false if fully identical."
        }
      }
    },
    "strMarkerValue": {
      "type": "object",
      "description": "A single STR marker value. Handles simple, multi-copy, and complex multi-allelic markers.",
      "required": [
        "marker",
        "value"
      ],
      "properties": {
        "marker": {
          "type": "string",
          "description": "Standard marker name (e.g., 'DYS393', 'DYS385a', 'DYF399X')."
        },
        "value": {
          "type": "ref",
          "ref": "#strValue",
          "description": "The marker value - simple integer or complex allele structure."
        },
        "panel": {
          "type": "string",
          "description": "Which panel this marker belongs to.",
          "knownValues": [
            "Y12",
            "Y25",
            "Y37",
            "Y67",
            "Y111",
            "Y500",
            "Y700",
            "YSEQ",
            "FTDNA_BIG_Y",
            "OTHER"
          ]
        },
        "quality": {
          "type": "string",
          "description": "Call quality if available.",
          "knownValues": [
            "HIGH",
            "MEDIUM",
            "LOW",
            "UNCERTAIN"
          ]
        },
        "readDepth": {
          "type": "integer",
          "description": "Read depth for WGS-derived STR calls."
        }
      }
    },
    "strValue": {
      "type": "union",
      "description": "STR value - either a simple repeat count or complex multi-allelic structure.",
      "refs": [
        "#simpleStrValue",
        "#multiCopyStrValue",
        "#complexStrValue"
      ]
    },
    "simpleStrValue": {
      "type": "object",
      "description": "Simple single-value STR (e.g., DYS393 = 13).",
      "required": [
        "type",
        "repeats"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "simple"
        },
        "repeats": {
          "type": "integer",
          "description": "Number of tandem repeats."
        }
      }
    },
    "multiCopyStrValue": {
      "type": "object",
      "description": "Multi-copy STR with ordered values (e.g., DYS385a/b = 11-14, DYS459a/b = 9-10).",
      "required": [
        "type",
        "copies"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "multiCopy"
        },
        "copies": {
          "type": "array",
          "description": "Ordered repeat counts for each copy (convention: ascending order).",
          "items": {
            "type": "integer"
          },
          "minItems": 2
        }
      }
    },
    "complexStrValue": {
      "type": "object",
      "description": "Complex multi-allelic STR with allele counts (e.g., DYF399X = 22t-25c-26.1t). Used for palindromic markers.",
      "required": [
        "type",
        "alleles"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "complex"
        },
        "alleles": {
          "type": "array",
          "description": "List of alleles with their repeat values and counts.",
          "items": {
            "type": "ref",
            "ref": "#strAllele"
          },
          "minItems": 1
        },
        "rawNotation": {
          "type": "string",
          "description": "Original notation string for reference (e.g., '22t-25c-26.1t')."
        }
      }
    },
    "strAllele": {
      "type": "object",
      "description": "A single allele in a complex STR marker.",
      "required": [
        "repeats",
        "count"
      ],
      "properties": {
        "repeats": {
          "type": "float",
          "description": "Repeat count (float to handle partial repeats like 26.1)."
        },
        "count": {
          "type": "integer",
          "description": "Number of copies of this allele (e.g., 2 for 'c' = cis/both copies)."
        },
        "designation": {
          "type": "string",
          "description": "Allele designation letter if applicable.",
          "knownValues": [
            "t",
            "c",
            "q"
          ]
        }
      }
    },
    "strPanel": {
      "type": "object",
      "description": "Metadata about an STR panel/test.",
      "required": [
        "panelName",
        "markerCount"
      ],
      "properties": {
        "panelName": {
          "type": "string",
          "description": "Panel name (e.g., 'Y-37', 'Big Y-700 STRs').",
          "knownValues": [
            "Y12",
            "Y25",
            "Y37",
            "Y67",
            "Y111",
            "Y500",
            "Y700",
            "YSEQ_ALPHA",
            "CUSTOM"
          ]
        },
        "markerCount": {
          "type": "integer",
          "description": "Number of markers in this panel."
        },
        "provider": {
          "type": "string",
          "description": "Testing company or source.",
          "knownValues": [
            "FTDNA",
            "YSEQ",
            "NEBULA",
            "DANTE",
            "WGS_DERIVED",
            "OTHER"
          ]
        },
        "testDate": {
          "type": "string",
          "format": "datetime",
          "description": "When the test was performed."
        }
      }
    },
    "ancestralStrState": {
      "type": "object",
      "description": "Reconstructed ancestral STR state for a haplogroup branch node.",
      "required": [
        "marker",
        "ancestralValue"
      ],
      "properties": {
        "marker": {
          "type": "string",
          "description": "STR marker name."
        },
        "ancestralValue": {
          "type": "ref",
          "ref": "#strValue",
          "description": "Reconstructed ancestral value at this branch point."
        },
        "confidence": {
          "type": "float",
          "description": "Confidence in reconstruction (0.0-1.0)."
        },
        "supportingSamples": {
          "type": "integer",
          "description": "Number of descendant samples used in reconstruction."
        },
        "variance": {
          "type": "float",
          "description": "Variance observed among descendants."
        },
        "method": {
          "type": "string",
          "description": "Reconstruction method used.",
          "knownValues": [
            "MODE",
            "MEDIAN",
            "PARSIMONY",
            "ML_PHYLOGENETIC"
          ]
        }
      }
    },
    "reconciliationStatus": {
      "type": "object",
      "description": "Summary of multi-run reconciliation for a biosample's haplogroup assignments.",
      "required": [
        "compatibilityLevel",
        "consensusHaplogroup"
      ],
      "properties": {
        "compatibilityLevel": {
          "type": "string",
          "description": "Overall compatibility across all runs.",
          "knownValues": [
            "COMPATIBLE",
            "MINOR_DIVERGENCE",
            "MAJOR_DIVERGENCE",
            "INCOMPATIBLE"
          ]
        },
        "consensusHaplogroup": {
          "type": "string",
          "description": "The reconciled consensus haplogroup across all runs."
        },
        "confidence": {
          "type": "float",
          "description": "Confidence in the consensus (0.0-1.0)."
        },
        "divergencePoint": {
          "type": "string",
          "description": "The last common ancestor haplogroup if runs diverge (e.g., 'R-DF13')."
        },
        "branchCompatibilityScore": {
          "type": "float",
          "description": "LCA_depth / max(depth_A, depth_B). 1.0 = fully compatible, <0.5 = likely different individuals."
        },
        "snpConcordance": {
          "type": "float",
          "description": "matching_calls / (matching + conflicting). 0.99+ = same individual."
        },
        "runCount": {
          "type": "integer",
          "description": "Number of runs included in reconciliation."
        },
        "warnings": {
          "type": "array",
          "description": "Any warnings generated during reconciliation.",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "runHaplogroupCall": {
      "type": "object",
      "description": "A haplogroup call from a single sequencing run or STR profile with quality metrics.",
      "required": [
        "sourceRef",
        "haplogroup",
        "confidence",
        "callMethod"
      ],
      "properties": {
        "sourceRef": {
          "type": "string",
          "description": "AT URI of the data source: sequence run, alignment, or STR profile."
        },
        "haplogroup": {
          "type": "string",
          "description": "The called haplogroup."
        },
        "confidence": {
          "type": "float",
          "description": "Confidence score for this call (0.0-1.0)."
        },
        "callMethod": {
          "type": "string",
          "description": "Method used to determine haplogroup.",
          "knownValues": [
            "SNP_PHYLOGENETIC",
            "STR_PREDICTION",
            "VENDOR_REPORTED"
          ]
        },
        "score": {
          "type": "float",
          "description": "Raw scoring result from haplogroup assignment."
        },
        "supportingSnps": {
          "type": "integer",
          "description": "Number of derived SNPs supporting this call (SNP-based only)."
        },
        "conflictingSnps": {
          "type": "integer",
          "description": "Number of SNPs contradicting this call (SNP-based only)."
        },
        "noCalls": {
          "type": "integer",
          "description": "Number of defining SNPs with no call (SNP-based only)."
        },
        "technology": {
          "type": "string",
          "description": "Sequencing/testing technology used.",
          "knownValues": [
            "WGS",
            "WES",
            "BIG_Y",
            "SNP_ARRAY",
            "AMPLICON",
            "STR_PANEL"
          ]
        },
        "meanCoverage": {
          "type": "float",
          "description": "Mean coverage in the haplogroup-relevant region (sequencing only)."
        },
        "treeVersion": {
          "type": "string",
          "description": "Haplogroup tree version used for this call."
        },
        "strPrediction": {
          "type": "ref",
          "ref": "#strHaplogroupPrediction",
          "description": "Details of STR-based prediction (when callMethod is STR_PREDICTION)."
        }
      }
    },
    "strHaplogroupPrediction": {
      "type": "object",
      "description": "Haplogroup prediction based on Y-STR profile analysis.",
      "required": [
        "predictedHaplogroup",
        "probability"
      ],
      "properties": {
        "predictedHaplogroup": {
          "type": "string",
          "description": "The predicted haplogroup from STR analysis."
        },
        "probability": {
          "type": "float",
          "description": "Probability of this prediction being correct (0.0-1.0)."
        },
        "predictionMethod": {
          "type": "string",
          "description": "Algorithm used for prediction.",
          "knownValues": [
            "NEVGEN",
            "HAPEST",
            "YHAPLO",
            "SAPP",
            "BAYESIAN",
            "CUSTOM"
          ]
        },
        "alternativePredictions": {
          "type": "array",
          "description": "Other possible haplogroups with their probabilities.",
          "items": {
            "type": "object",
            "properties": {
              "haplogroup": {
                "type": "string"
              },
              "probability": {
                "type": "float"
              }
            }
          }
        },
        "markersUsed": {
          "type": "integer",
          "description": "Number of STR markers used in prediction."
        },
        "panelName": {
          "type": "string",
          "description": "STR panel used (e.g., Y-37, Y-111)."
        },
        "predictionDepth": {
          "type": "string",
          "description": "Expected depth/resolution of STR-based prediction.",
          "knownValues": [
            "MAJOR_CLADE",
            "SUBCLADE",
            "TERMINAL"
          ]
        },
        "modalMatch": {
          "type": "object",
          "description": "Best matching modal haplotype if applicable.",
          "properties": {
            "haplogroup": {
              "type": "string",
              "description": "Haplogroup of the modal."
            },
            "geneticDistance": {
              "type": "integer",
              "description": "Genetic distance (step mutations) from modal."
            },
            "sampleCount": {
              "type": "integer",
              "description": "Number of samples in the modal reference set."
            }
          }
        },
        "limitations": {
          "type": "array",
          "description": "Known limitations of this prediction.",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "snpConflict": {
      "type": "object",
      "description": "A conflict at a specific SNP position between runs.",
      "required": [
        "position",
        "calls"
      ],
      "properties": {
        "position": {
          "type": "integer",
          "description": "Genomic position of the conflict."
        },
        "snpName": {
          "type": "string",
          "description": "SNP name if known (e.g., 'M269', 'L21')."
        },
        "contigAccession": {
          "type": "string",
          "description": "GenBank accession for the contig."
        },
        "calls": {
          "type": "array",
          "description": "The different calls from each run.",
          "items": {
            "type": "ref",
            "ref": "#snpCallFromRun"
          }
        },
        "resolution": {
          "type": "string",
          "description": "How the conflict was resolved.",
          "knownValues": [
            "ACCEPT_MAJORITY",
            "ACCEPT_HIGHER_QUALITY",
            "ACCEPT_HIGHER_COVERAGE",
            "UNRESOLVED",
            "HETEROPLASMY"
          ]
        },
        "resolvedValue": {
          "type": "string",
          "description": "The resolved allele value if resolution was applied."
        }
      }
    },
    "snpCallFromRun": {
      "type": "object",
      "description": "A single SNP call from one run.",
      "required": [
        "runRef",
        "allele"
      ],
      "properties": {
        "runRef": {
          "type": "string",
          "description": "AT URI of the run that made this call."
        },
        "allele": {
          "type": "string",
          "description": "Called allele (e.g., 'A', 'T', 'NO_CALL')."
        },
        "quality": {
          "type": "float",
          "description": "Call quality score."
        },
        "depth": {
          "type": "integer",
          "description": "Read depth at this position."
        },
        "variantAlleleFrequency": {
          "type": "float",
          "description": "VAF for heteroplasmy detection (mtDNA)."
        }
      }
    },
    "heteroplasmyObservation": {
      "type": "object",
      "description": "An observation of mtDNA heteroplasmy at a specific position.",
      "required": [
        "position",
        "majorAllele",
        "minorAllele",
        "majorAlleleFrequency"
      ],
      "properties": {
        "position": {
          "type": "integer",
          "description": "Mitochondrial genome position."
        },
        "majorAllele": {
          "type": "string",
          "description": "The predominant allele."
        },
        "minorAllele": {
          "type": "string",
          "description": "The minor allele."
        },
        "majorAlleleFrequency": {
          "type": "float",
          "description": "Frequency of the major allele (0.5-1.0)."
        },
        "depth": {
          "type": "integer",
          "description": "Total read depth at this position."
        },
        "isDefiningSnp": {
          "type": "boolean",
          "description": "Whether this position is a haplogroup-defining SNP."
        },
        "affectedHaplogroup": {
          "type": "string",
          "description": "Haplogroup affected by this heteroplasmy if defining."
        }
      }
    },
    "identityVerification": {
      "type": "object",
      "description": "Metrics for verifying that multiple runs come from the same individual.",
      "properties": {
        "kinshipCoefficient": {
          "type": "float",
          "description": "Self-vs-self should be ~0.5, different individuals <0.05."
        },
        "fingerprintSnpConcordance": {
          "type": "float",
          "description": "Concordance on curated fingerprint SNP set (should be 1.0 for same individual)."
        },
        "yStrDistance": {
          "type": "integer",
          "description": "Genetic distance on Y-STR markers (should be 0 for same individual)."
        },
        "verificationStatus": {
          "type": "string",
          "description": "Overall verification result.",
          "knownValues": [
            "VERIFIED_SAME",
            "LIKELY_SAME",
            "UNCERTAIN",
            "LIKELY_DIFFERENT",
            "VERIFIED_DIFFERENT"
          ]
        },
        "verificationMethod": {
          "type": "string",
          "description": "Method used for verification.",
          "knownValues": [
            "AUTOSOMAL_KINSHIP",
            "Y_STR",
            "FINGERPRINT_SNPS",
            "COMBINED"
          ]
        }
      }
    }
  }
}
```

---

## Core Records

### 1. Workspace Record (`com.decodingus.atmosphere.workspace`)

This record serves as the root container for a Researcher's PDS, aggregating biosample references and defined research
projects.

**NSID:** `com.decodingus.atmosphere.workspace`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.workspace",
  "defs": {
    "main": {
      "type": "record",
      "description": "The root container for a Researcher's workspace, holding references to biosamples and projects.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "sampleRefs",
          "projectRefs"
        ],
        "properties": {
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "sampleRefs": {
            "type": "array",
            "description": "AT URIs of biosample records in this workspace.",
            "items": {
              "type": "string",
              "description": "AT URI of a com.decodingus.atmosphere.biosample record."
            }
          },
          "projectRefs": {
            "type": "array",
            "description": "AT URIs of project records in this workspace.",
            "items": {
              "type": "string",
              "description": "AT URI of a com.decodingus.atmosphere.project record."
            }
          }
        }
      }
    }
  }
}
```

---

### 2. Biosample Record (`com.decodingus.atmosphere.biosample`)

This record represents a single biological sample. It contains donor metadata and haplogroup assignments, but references
sequence runs and genotype data rather than embedding them.

**NSID:** `com.decodingus.atmosphere.biosample`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.biosample",
  "defs": {
    "main": {
      "type": "record",
      "description": "A record representing a biological sample and its donor metadata. Sequence and genotype data is referenced, not embedded.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "sampleAccession",
          "donorIdentifier",
          "centerName",
          "citizenDid",
          "atUri"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI (at://did/collection/rkey) of this biosample record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "sampleAccession": {
            "type": "string",
            "description": "Native identifier provided by the client for the biosample."
          },
          "donorIdentifier": {
            "type": "string",
            "description": "Identifier for the specimen donor within the user's context."
          },
          "citizenDid": {
            "type": "string",
            "description": "The Decentralized Identifier (DID) of the citizen/researcher who owns this biosample record."
          },
          "description": {
            "type": "string",
            "description": "Human-readable description of the sample."
          },
          "centerName": {
            "type": "string",
            "description": "The name of the Sequencing Center or BGS Node."
          },
          "sex": {
            "type": "string",
            "description": "Biological sex of the donor.",
            "knownValues": [
              "Male",
              "Female",
              "Other",
              "Unknown"
            ]
          },
          "haplogroups": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#haplogroupAssignments",
            "description": "Y-DNA and mtDNA haplogroup assignments derived from the sequencing data."
          },
          "sequenceRunRefs": {
            "type": "array",
            "description": "AT URIs of sequence run records associated with this biosample.",
            "items": {
              "type": "string",
              "description": "AT URI of a com.decodingus.atmosphere.sequencerun record."
            }
          },
          "genotypeRefs": {
            "type": "array",
            "description": "AT URIs of genotype data records (chip/array data) associated with this biosample.",
            "items": {
              "type": "string",
              "description": "AT URI of a com.decodingus.atmosphere.genotype record."
            }
          },
          "populationBreakdownRef": {
            "type": "string",
            "description": "AT URI of the population/ancestry breakdown for this biosample."
          },
          "strProfileRef": {
            "type": "string",
            "description": "AT URI of the Y-STR profile for this biosample."
          },
          "yDnaReconciliationRef": {
            "type": "string",
            "description": "AT URI of the Y-DNA haplogroup reconciliation record for this biosample."
          },
          "mtDnaReconciliationRef": {
            "type": "string",
            "description": "AT URI of the MT-DNA haplogroup reconciliation record for this biosample."
          }
        }
      }
    }
  }
}
```

---

### 3. Sequence Run Record (`com.decodingus.atmosphere.sequencerun`)

This record represents a single sequencing run (e.g., one library preparation and sequencing session). It is a
first-class record that can be created, updated, or deleted independently.

**NSID:** `com.decodingus.atmosphere.sequencerun`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.sequencerun",
  "defs": {
    "main": {
      "type": "record",
      "description": "A sequencing run representing one library preparation and sequencing session. Can be independently managed.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "biosampleRef",
          "platformName",
          "testType",
          "files"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this sequence run record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the parent biosample record."
          },
          "platformName": {
            "type": "string",
            "description": "Sequencing platform (e.g., ILLUMINA, PACBIO, NANOPORE).",
            "knownValues": [
              "ILLUMINA",
              "PACBIO",
              "NANOPORE",
              "ION_TORRENT",
              "BGI",
              "ELEMENT",
              "ULTIMA"
            ]
          },
          "instrumentModel": {
            "type": "string",
            "description": "Specific instrument model (e.g., NovaSeq 6000, Sequel II)."
          },
          "instrumentId": {
            "type": "string",
            "description": "Unique instrument identifier extracted from @RG headers (for lab inference)."
          },
          "testType": {
            "type": "string",
            "description": "Type of test (e.g., WGS, EXOME, TARGETED).",
            "knownValues": [
              "WGS",
              "EXOME",
              "TARGETED",
              "RNA_SEQ",
              "AMPLICON"
            ]
          },
          "libraryLayout": {
            "type": "string",
            "description": "Paired-end or Single-end.",
            "knownValues": [
              "PAIRED",
              "SINGLE"
            ]
          },
          "totalReads": {
            "type": "integer",
            "description": "Total number of reads."
          },
          "readLength": {
            "type": "integer",
            "description": "Average read length."
          },
          "meanInsertSize": {
            "type": "float",
            "description": "Mean insert size of the library."
          },
          "flowcellId": {
            "type": "string",
            "description": "Flowcell identifier if available from headers."
          },
          "runDate": {
            "type": "string",
            "format": "datetime",
            "description": "Date of the sequencing run if extractable."
          },
          "files": {
            "type": "array",
            "description": "Metadata about raw data files (e.g., FASTQs). Files remain local; only metadata (name, size, checksum) is stored here for provenance tracking.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#fileInfo"
            }
          },
          "alignmentRefs": {
            "type": "array",
            "description": "AT URIs of alignment records derived from this sequence run.",
            "items": {
              "type": "string",
              "description": "AT URI of a com.decodingus.atmosphere.alignment record."
            }
          }
        }
      }
    }
  }
}
```

---

### 4. Alignment Record (`com.decodingus.atmosphere.alignment`)

This record represents a single alignment of sequence data to a reference genome. It is independently managed, allowing
metrics updates without touching parent records.

**NSID:** `com.decodingus.atmosphere.alignment`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.alignment",
  "defs": {
    "main": {
      "type": "record",
      "description": "An alignment of sequence data to a reference genome. Independently managed for granular updates.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "sequenceRunRef",
          "referenceBuild",
          "aligner"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this alignment record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "sequenceRunRef": {
            "type": "string",
            "description": "AT URI of the parent sequence run record."
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the grandparent biosample (denormalized for query efficiency)."
          },
          "referenceBuild": {
            "type": "string",
            "description": "Reference genome build (e.g., GRCh38, GRCh37, T2T-CHM13).",
            "knownValues": [
              "GRCh38",
              "GRCh37",
              "T2T-CHM13",
              "hg19",
              "hg38"
            ]
          },
          "aligner": {
            "type": "string",
            "description": "Tool and version used for alignment (e.g., BWA-MEM 0.7.17)."
          },
          "variantCaller": {
            "type": "string",
            "description": "Tool used for variant calling (e.g., GATK HaplotypeCaller 4.2)."
          },
          "files": {
            "type": "array",
            "description": "Metadata about aligned data files (e.g., BAM, CRAM, VCF). Files remain local; only metadata is stored for provenance tracking.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#fileInfo"
            }
          },
          "metrics": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#alignmentMetrics"
          }
        }
      }
    }
  }
}
```

---

### 5. Genotype Record (`com.decodingus.atmosphere.genotype`)

This record represents genotyping array/chip data (e.g., 23andMe, AncestryDNA, FTDNA). It is a first-class record
separate from sequencing data. Raw genotype calls remain local on the Edge App; only metadata and derived results (
haplogroups, ancestry percentages) flow to DecodingUs.

**NSID:** `com.decodingus.atmosphere.genotype`

**Status:** ðŸš§ In Development (Navigator Desktop Implementation)

**Supported Vendors**: 23andMe, AncestryDNA, FamilyTreeDNA, MyHeritage, LivingDNA

**Test Type Codes** (per multi-test-type-roadmap.md):

- `ARRAY_23ANDME_V5` - 23andMe v5 chip (~640K markers)
- `ARRAY_23ANDME_V4` - 23andMe v4 chip (~570K markers)
- `ARRAY_ANCESTRY_V2` - AncestryDNA v2 (~700K markers)
- `ARRAY_FTDNA_FF` - FTDNA Family Finder (~700K markers)
- `ARRAY_MYHERITAGE` - MyHeritage DNA (~700K markers)
- `ARRAY_LIVINGDNA` - LivingDNA (~630K markers)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.genotype",
  "defs": {
    "main": {
      "type": "record",
      "description": "Genotyping array/chip data from DTC providers. Raw genotypes stay local; only metadata flows to DecodingUs.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "biosampleRef",
          "testTypeCode",
          "provider"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this genotype record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the parent biosample record."
          },
          "testTypeCode": {
            "type": "string",
            "description": "Test type code from the taxonomy.",
            "knownValues": [
              "ARRAY_23ANDME_V5",
              "ARRAY_23ANDME_V4",
              "ARRAY_ANCESTRY_V2",
              "ARRAY_FTDNA_FF",
              "ARRAY_MYHERITAGE",
              "ARRAY_LIVINGDNA",
              "ARRAY_CUSTOM"
            ]
          },
          "provider": {
            "type": "string",
            "description": "The genotyping provider or company.",
            "knownValues": [
              "23andMe",
              "AncestryDNA",
              "FamilyTreeDNA",
              "MyHeritage",
              "LivingDNA",
              "Nebula",
              "Custom"
            ]
          },
          "chipVersion": {
            "type": "string",
            "description": "Specific chip version identifier (e.g., 'v5', 'v2')."
          },
          "totalMarkersCalled": {
            "type": "integer",
            "description": "Number of markers with valid genotype calls."
          },
          "totalMarkersPossible": {
            "type": "integer",
            "description": "Total markers on the chip/array."
          },
          "noCallRate": {
            "type": "float",
            "description": "Percentage of markers with no call (0.0-1.0)."
          },
          "yMarkersCalled": {
            "type": "integer",
            "description": "Number of Y-DNA markers with calls (for haplogroup confidence)."
          },
          "yMarkersTotal": {
            "type": "integer",
            "description": "Total Y-DNA markers on chip."
          },
          "mtMarkersCalled": {
            "type": "integer",
            "description": "Number of mtDNA markers with calls."
          },
          "mtMarkersTotal": {
            "type": "integer",
            "description": "Total mtDNA markers on chip."
          },
          "autosomalMarkersCalled": {
            "type": "integer",
            "description": "Number of autosomal markers with calls (for ancestry/IBD)."
          },
          "hetRate": {
            "type": "float",
            "description": "Heterozygosity rate across autosomal markers (quality check)."
          },
          "testDate": {
            "type": "string",
            "format": "datetime",
            "description": "Date the genotyping was performed."
          },
          "processedAt": {
            "type": "string",
            "format": "datetime",
            "description": "When the file was processed by Navigator."
          },
          "buildVersion": {
            "type": "string",
            "description": "Reference genome build for coordinates.",
            "knownValues": [
              "GRCh37",
              "GRCh38"
            ]
          },
          "sourceFileHash": {
            "type": "string",
            "description": "SHA-256 hash of source file for deduplication."
          },
          "files": {
            "type": "array",
            "description": "Metadata about genotype data files. Files remain local; only metadata is stored for provenance tracking.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#fileInfo"
            }
          },
          "derivedHaplogroups": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#haplogroupAssignments",
            "description": "Haplogroups derived from chip Y/mtDNA markers."
          },
          "populationBreakdownRef": {
            "type": "string",
            "description": "AT URI of the population breakdown derived from this genotype data."
          },
          "imputationRef": {
            "type": "string",
            "description": "AT URI of imputation results if available."
          }
        }
      }
    }
  }
}
```

**Edge App Processing**: Navigator Desktop processes chip files locally:

1. Auto-detects vendor format from file header
2. Parses genotype calls (stays local, never uploaded)
3. Computes summary statistics (marker counts, call rates)
4. Extracts Y/mtDNA markers for haplogroup analysis
5. Runs ancestry analysis using autosomal markers
6. Syncs metadata and derived results to PDS

---

### 6. Imputation Record (`com.decodingus.atmosphere.imputation`)

This record represents imputed genotype data derived from array data.

**NSID:** `com.decodingus.atmosphere.imputation`

**Status:** ðŸ”® Future Scope (Multi-Test Type Support)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.imputation",
  "defs": {
    "main": {
      "type": "record",
      "description": "Imputed genotype data derived from array genotyping.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "genotypeRef",
          "referencePanel",
          "imputationTool"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this imputation record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "genotypeRef": {
            "type": "string",
            "description": "AT URI of the source genotype record."
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the grandparent biosample (denormalized)."
          },
          "referencePanel": {
            "type": "string",
            "description": "Reference panel used for imputation.",
            "knownValues": [
              "TOPMED",
              "HRC",
              "1000G_PHASE3",
              "CUSTOM"
            ]
          },
          "imputationTool": {
            "type": "string",
            "description": "Tool used for imputation (e.g., 'Minimac4', 'IMPUTE5')."
          },
          "imputedVariantCount": {
            "type": "integer",
            "description": "Number of variants imputed."
          },
          "averageInfoScore": {
            "type": "float",
            "description": "Average imputation quality score (INFO/R2)."
          },
          "files": {
            "type": "array",
            "description": "Metadata about imputed VCF files. Files remain local; only metadata is stored for provenance tracking.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#fileInfo"
            }
          }
        }
      }
    }
  }
}
```

---

### 7. Project Record (`com.decodingus.atmosphere.project`)

This record defines a research project that aggregates multiple biosamples within a Researcher's PDS.

**NSID:** `com.decodingus.atmosphere.project`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.project",
  "defs": {
    "main": {
      "type": "record",
      "description": "A genealogy or research project that aggregates multiple biosamples.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "projectName",
          "administrator",
          "memberRefs"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this project record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "projectName": {
            "type": "string",
            "description": "Name of the project (e.g., 'Smith Surname Project')."
          },
          "description": {
            "type": "string",
            "description": "Goals and scope of the research."
          },
          "administrator": {
            "type": "string",
            "description": "The DID of the researcher managing this project."
          },
          "memberRefs": {
            "type": "array",
            "description": "AT URIs of biosample records associated with this project.",
            "items": {
              "type": "string",
              "description": "AT URI of a com.decodingus.atmosphere.biosample record."
            }
          }
        }
      }
    }
  }
}
```

---

## Ancestry & Population Records

### 8. Population Breakdown Record (`com.decodingus.atmosphere.populationBreakdown`)

This record contains ancestry composition analysis results using PCA projection onto reference populations from 1000
Genomes and HGDP/SGDP. Provides ADMIXTURE-style ancestry breakdowns at sub-continental granularity (~33 populations
organized into 9 super-populations).

**NSID:** `com.decodingus.atmosphere.populationBreakdown`

**Status:** ðŸš§ In Development (Navigator Desktop Implementation)

**Algorithm**: PCA Projection + Gaussian Mixture Model

- Projects sample genotypes onto pre-computed PCA space from reference populations
- Calculates Mahalanobis distance to population centroids
- Converts distances to probabilities via multivariate Gaussian PDF
- Supports two panel types: AIMs (~5k SNPs, ~2-5 min) and genome-wide (~500k SNPs, ~20-30 min)

**Reference Populations (33 total)**:

- **European (5)**: CEU, FIN, GBR, IBS, TSI
- **African (5)**: YRI, LWK, ESN, MSL, GWD
- **East Asian (5)**: CHB, JPT, KHV, CHS, CDX
- **South Asian (5)**: GIH, PJL, BEB, STU, ITU
- **Americas (4)**: MXL, PUR, PEL, CLM
- **West Asian (3)**: Druze, Palestinian, Bedouin (HGDP)
- **Oceanian (2)**: Papuan, Melanesian (HGDP)
- **Central Asian (1)**: Yakut (HGDP)
- **Native American (3)**: Maya, Pima, Karitiana (HGDP)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.populationBreakdown",
  "defs": {
    "main": {
      "type": "record",
      "description": "Ancestry composition analysis showing population percentages from atDNA analysis.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "biosampleRef",
          "analysisMethod",
          "panelType",
          "components"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this population breakdown record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the parent biosample record."
          },
          "analysisMethod": {
            "type": "string",
            "description": "The analysis method/algorithm used.",
            "knownValues": [
              "PCA_PROJECTION_GMM",
              "ADMIXTURE",
              "FASTSTRUCTURE",
              "SUPERVISED_ML",
              "CUSTOM"
            ]
          },
          "panelType": {
            "type": "string",
            "description": "SNP panel used for analysis.",
            "knownValues": [
              "aims",
              "genome-wide"
            ]
          },
          "referencePopulations": {
            "type": "string",
            "description": "Reference population dataset used.",
            "knownValues": [
              "1000G_HGDP_v1",
              "1000G",
              "HGDP",
              "Custom"
            ]
          },
          "snpsAnalyzed": {
            "type": "integer",
            "description": "Total number of SNPs in the analysis panel."
          },
          "snpsWithGenotype": {
            "type": "integer",
            "description": "Number of SNPs with valid genotype calls from the sample."
          },
          "snpsMissing": {
            "type": "integer",
            "description": "Number of SNPs with no call or missing data."
          },
          "confidenceLevel": {
            "type": "float",
            "description": "Overall confidence score (0.0-1.0) based on data quality and completeness."
          },
          "components": {
            "type": "array",
            "description": "List of sub-continental population components with percentages.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#populationComponent"
            }
          },
          "superPopulationSummary": {
            "type": "array",
            "description": "Aggregated percentages at the continental level.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#superPopulationSummary"
            }
          },
          "pcaCoordinates": {
            "type": "array",
            "description": "First 3 principal component coordinates for visualization.",
            "items": {
              "type": "float"
            },
            "maxItems": 3
          },
          "analysisDate": {
            "type": "string",
            "format": "datetime",
            "description": "When the analysis was performed."
          },
          "pipelineVersion": {
            "type": "string",
            "description": "Version of the analysis pipeline (e.g., '1.0.0')."
          },
          "referenceVersion": {
            "type": "string",
            "description": "Version of the reference panel data (e.g., 'v1')."
          }
        }
      }
    }
  }
}
```

**IBD Matching Integration**: Population breakdown data enables:

- **Match contextualization**: Understand shared ancestry context for IBD matches
- **Endogamy detection**: Identify populations with higher background relatedness
- **Geographic correlation**: Map genetic ancestry to geographic origins
- **Match introduction text**: Generate meaningful connection descriptions (e.g., "You share 45cM with this person who
  has similar Northwestern European ancestry")

---

## Discovery & Inference Records

### 9. Instrument Observation Record (`com.decodingus.atmosphere.instrumentObservation`)

This record allows citizens to contribute instrument-lab observations from their sequencing data for crowdsourced lab
discovery.

**NSID:** `com.decodingus.atmosphere.instrumentObservation`

**Status:** ðŸ”® Future Scope (Sequencer Lab Inference System)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.instrumentObservation",
  "defs": {
    "main": {
      "type": "record",
      "description": "An observation of a sequencer instrument and its associated laboratory, extracted from BAM/CRAM read headers.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "instrumentId",
          "labName",
          "biosampleRef"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this observation record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "instrumentId": {
            "type": "string",
            "description": "The instrument ID extracted from the @RG header (e.g., 'A00123').",
            "minLength": 1,
            "maxLength": 255
          },
          "labName": {
            "type": "string",
            "description": "The name of the sequencing laboratory (as known by the user or inferred).",
            "minLength": 1,
            "maxLength": 255
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the biosample from which this observation was extracted."
          },
          "sequenceRunRef": {
            "type": "string",
            "description": "AT URI of the specific sequence run (optional, for precision)."
          },
          "platform": {
            "type": "string",
            "description": "Sequencing platform (e.g., 'ILLUMINA', 'PACBIO').",
            "knownValues": [
              "ILLUMINA",
              "PACBIO",
              "NANOPORE",
              "MGI",
              "ELEMENT",
              "ULTIMA"
            ]
          },
          "instrumentModel": {
            "type": "string",
            "description": "Inferred or known instrument model (e.g., 'NovaSeq 6000')."
          },
          "flowcellId": {
            "type": "string",
            "description": "Flowcell identifier if extractable from read headers."
          },
          "runDate": {
            "type": "string",
            "format": "datetime",
            "description": "Date of the sequencing run if extractable."
          },
          "confidence": {
            "type": "string",
            "description": "Confidence level of the lab association.",
            "knownValues": [
              "KNOWN",
              "INFERRED",
              "GUESSED"
            ],
            "default": "INFERRED"
          }
        }
      }
    }
  }
}
```

---

## IBD Matching Records

### 10. Match Consent Record (`com.decodingus.atmosphere.matchConsent`)

This record represents a citizen's consent for IBD matching. Without this record, no matching is performed.

**NSID:** `com.decodingus.atmosphere.matchConsent`

**Status:** ðŸ”® Future Scope (IBD Matching System)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.matchConsent",
  "defs": {
    "main": {
      "type": "record",
      "description": "Consent record for IBD matching participation. Presence enables matching; deletion revokes consent.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "biosampleRef",
          "consentLevel"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this consent record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the biosample for which consent is granted."
          },
          "consentLevel": {
            "type": "string",
            "description": "Level of matching participation.",
            "knownValues": [
              "FULL",
              "ANONYMOUS",
              "PROJECT_ONLY"
            ]
          },
          "allowedMatchTypes": {
            "type": "array",
            "description": "Types of matching allowed.",
            "items": {
              "type": "string",
              "knownValues": [
                "IBD",
                "Y_STR",
                "MT_SEQUENCE",
                "AUTOSOMAL"
              ]
            }
          },
          "minimumSegmentCm": {
            "type": "float",
            "description": "Minimum segment size (cM) for matches to be shared. Default: 7.0"
          },
          "shareContactInfo": {
            "type": "boolean",
            "description": "Whether to share contact information with matches."
          },
          "consentedAt": {
            "type": "string",
            "format": "datetime",
            "description": "When consent was granted."
          },
          "expiresAt": {
            "type": "string",
            "format": "datetime",
            "description": "Optional expiration date for consent."
          }
        }
      }
    }
  }
}
```

---

### 11. Match List Record (`com.decodingus.atmosphere.matchList`)

This record contains the list of IBD matches for a biosample, updated by the DecodingUs AppView.

**NSID:** `com.decodingus.atmosphere.matchList`

**Status:** ðŸ”® Future Scope (IBD Matching System)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.matchList",
  "defs": {
    "main": {
      "type": "record",
      "description": "List of IBD matches for a biosample. Updated by the DecodingUs AppView.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "biosampleRef",
          "matches"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this match list record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the biosample these matches belong to."
          },
          "matchCount": {
            "type": "integer",
            "description": "Total number of matches in this list."
          },
          "lastCalculatedAt": {
            "type": "string",
            "format": "datetime",
            "description": "When matches were last calculated."
          },
          "matches": {
            "type": "array",
            "description": "List of matches.",
            "items": {
              "type": "ref",
              "ref": "#matchEntry"
            }
          },
          "continuationToken": {
            "type": "string",
            "description": "Token for paginating through large match lists."
          }
        }
      }
    },
    "matchEntry": {
      "type": "object",
      "description": "A single match entry in the match list.",
      "required": [
        "matchedBiosampleRef",
        "totalSharedCm",
        "segmentCount"
      ],
      "properties": {
        "matchedBiosampleRef": {
          "type": "string",
          "description": "AT URI of the matched biosample."
        },
        "matchedCitizenDid": {
          "type": "string",
          "description": "DID of the matched citizen (if they consent to sharing)."
        },
        "relationshipEstimate": {
          "type": "string",
          "description": "Estimated relationship (e.g., '2nd Cousin', 'Half Sibling').",
          "knownValues": [
            "PARENT_CHILD",
            "FULL_SIBLING",
            "HALF_SIBLING",
            "GRANDPARENT",
            "AUNT_UNCLE",
            "1ST_COUSIN",
            "1ST_COUSIN_1R",
            "2ND_COUSIN",
            "2ND_COUSIN_1R",
            "3RD_COUSIN",
            "4TH_COUSIN",
            "5TH_COUSIN",
            "DISTANT",
            "UNKNOWN"
          ]
        },
        "totalSharedCm": {
          "type": "float",
          "description": "Total centiMorgans shared across all segments."
        },
        "longestSegmentCm": {
          "type": "float",
          "description": "Length of the longest shared segment in cM."
        },
        "segmentCount": {
          "type": "integer",
          "description": "Number of shared segments."
        },
        "sharedSegments": {
          "type": "array",
          "description": "Detailed segment information (optional, can be large).",
          "items": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#ibdSegment"
          }
        },
        "matchedAt": {
          "type": "string",
          "format": "datetime",
          "description": "When this match was first detected."
        },
        "xMatchSharedCm": {
          "type": "float",
          "description": "cM shared on X chromosome (for X-DNA matching)."
        }
      }
    }
  }
}
```

---

### 12. Match Request Record (`com.decodingus.atmosphere.matchRequest`)

This record represents a request to initiate contact with a match.

**NSID:** `com.decodingus.atmosphere.matchRequest`

**Status:** ðŸ”® Future Scope (IBD Matching System)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.matchRequest",
  "defs": {
    "main": {
      "type": "record",
      "description": "A request to initiate contact with a genetic match.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "fromBiosampleRef",
          "toBiosampleRef",
          "status"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this match request record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "fromBiosampleRef": {
            "type": "string",
            "description": "AT URI of the requesting biosample."
          },
          "toBiosampleRef": {
            "type": "string",
            "description": "AT URI of the target biosample."
          },
          "status": {
            "type": "string",
            "description": "Current status of the request.",
            "knownValues": [
              "PENDING",
              "ACCEPTED",
              "DECLINED",
              "EXPIRED",
              "WITHDRAWN"
            ]
          },
          "message": {
            "type": "string",
            "description": "Optional message to the match.",
            "maxLength": 1000
          },
          "sharedAncestorHint": {
            "type": "string",
            "description": "Suspected common ancestor or family line.",
            "maxLength": 500
          },
          "expiresAt": {
            "type": "string",
            "format": "datetime",
            "description": "When this request expires if not responded to."
          },
          "respondedAt": {
            "type": "string",
            "format": "datetime",
            "description": "When the request was responded to."
          }
        }
      }
    }
  }
}
```

---

## STR Records

### 13. STR Profile Record (`com.decodingus.atmosphere.strProfile`)

This record contains a biosample's Y-STR profile data. STRs may come from dedicated STR tests (FTDNA Y-37, Y-111, etc.)
or be derived from WGS/Big Y data.

**NSID:** `com.decodingus.atmosphere.strProfile`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.strProfile",
  "defs": {
    "main": {
      "type": "record",
      "description": "Y-STR profile for a biosample. Can contain multiple panels from different sources.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "biosampleRef",
          "markers"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this STR profile record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the parent biosample."
          },
          "sequenceRunRef": {
            "type": "string",
            "description": "AT URI of the sequence run if STRs were derived from WGS (optional)."
          },
          "panels": {
            "type": "array",
            "description": "Panels/tests that contributed to this profile.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#strPanel"
            }
          },
          "markers": {
            "type": "array",
            "description": "The STR marker values.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#strMarkerValue"
            }
          },
          "totalMarkers": {
            "type": "integer",
            "description": "Total number of markers in this profile."
          },
          "source": {
            "type": "string",
            "description": "How these STRs were obtained.",
            "knownValues": [
              "DIRECT_TEST",
              "WGS_DERIVED",
              "BIG_Y_DERIVED",
              "IMPORTED",
              "MANUAL_ENTRY"
            ]
          },
          "importedFrom": {
            "type": "string",
            "description": "If imported, the original source (e.g., 'FTDNA', 'YSEQ', 'YFULL')."
          },
          "derivationMethod": {
            "type": "string",
            "description": "For WGS-derived STRs, the tool/method used.",
            "knownValues": [
              "HIPSTR",
              "GANGSTR",
              "EXPANSION_HUNTER",
              "LOBSTR",
              "CUSTOM"
            ]
          },
          "files": {
            "type": "array",
            "description": "Source CSV/TSV files if available.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#fileInfo"
            }
          }
        }
      }
    }
  }
}
```

---

### 14. Haplogroup Ancestral STR Record (`com.decodingus.atmosphere.haplogroupAncestralStr`)

This record contains the reconstructed ancestral STR state for a haplogroup branch node in the Y-DNA tree. Computed by
the AppView using phylogenetic reconstruction methods.

**NSID:** `com.decodingus.atmosphere.haplogroupAncestralStr`

**Status:** ðŸ”® Future Scope (Y-DNA Tree Enhancement)

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.haplogroupAncestralStr",
  "defs": {
    "main": {
      "type": "record",
      "description": "Reconstructed ancestral STR haplotype for a haplogroup branch node.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "haplogroup",
          "ancestralMarkers",
          "computedAt"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this ancestral STR record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "haplogroup": {
            "type": "string",
            "description": "The haplogroup this ancestral state represents (e.g., 'R-M269', 'I-M253')."
          },
          "haplogroupTreeRef": {
            "type": "string",
            "description": "Reference to the haplogroup tree version used."
          },
          "parentHaplogroup": {
            "type": "string",
            "description": "Parent haplogroup in the tree (for computing mutations along branch)."
          },
          "ancestralMarkers": {
            "type": "array",
            "description": "Reconstructed ancestral STR values with confidence.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#ancestralStrState"
            }
          },
          "sampleCount": {
            "type": "integer",
            "description": "Number of descendant samples used in reconstruction."
          },
          "computedAt": {
            "type": "string",
            "format": "datetime",
            "description": "When this reconstruction was computed."
          },
          "method": {
            "type": "string",
            "description": "Overall reconstruction method.",
            "knownValues": [
              "MODAL",
              "MEDIAN",
              "PARSIMONY",
              "BAYESIAN",
              "ML_PHYLOGENETIC"
            ]
          },
          "softwareVersion": {
            "type": "string",
            "description": "Version of reconstruction software used."
          },
          "mutationRateModel": {
            "type": "string",
            "description": "Mutation rate model used (if applicable).",
            "knownValues": [
              "FTDNA_INFINITE_ALLELES",
              "BALLANTYNE_2010",
              "BURGARELLA_2012",
              "CUSTOM"
            ]
          },
          "tmrcaEstimate": {
            "type": "object",
            "description": "Time to Most Recent Common Ancestor based on STR variance.",
            "properties": {
              "yearsBeforePresent": {
                "type": "integer"
              },
              "confidenceInterval": {
                "type": "object",
                "properties": {
                  "lower": {
                    "type": "integer"
                  },
                  "upper": {
                    "type": "integer"
                  }
                }
              },
              "generationTime": {
                "type": "integer",
                "description": "Generation time assumption used (years)."
              }
            }
          },
          "branchMutations": {
            "type": "array",
            "description": "Inferred STR mutations along the branch from parent haplogroup.",
            "items": {
              "type": "ref",
              "ref": "#strBranchMutation"
            }
          }
        }
      }
    },
    "strBranchMutation": {
      "type": "object",
      "description": "An inferred STR mutation along a haplogroup branch.",
      "required": [
        "marker",
        "fromValue",
        "toValue"
      ],
      "properties": {
        "marker": {
          "type": "string",
          "description": "STR marker that mutated."
        },
        "fromValue": {
          "type": "ref",
          "ref": "com.decodingus.atmosphere.defs#strValue",
          "description": "Ancestral value (from parent haplogroup)."
        },
        "toValue": {
          "type": "ref",
          "ref": "com.decodingus.atmosphere.defs#strValue",
          "description": "Derived value (at this haplogroup)."
        },
        "stepChange": {
          "type": "integer",
          "description": "Net change in repeat count (positive = gain, negative = loss)."
        },
        "confidence": {
          "type": "float",
          "description": "Confidence in this mutation inference (0.0-1.0)."
        }
      }
    }
  }
}
```

---

### 15. Haplogroup Reconciliation Record (`com.decodingus.atmosphere.haplogroupReconciliation`)

This record contains the reconciliation results when a biosample has multiple sequencing runs with potentially different
haplogroup calls. It tracks per-run calls, conflicts, and the consensus result.

**NSID:** `com.decodingus.atmosphere.haplogroupReconciliation`

```json
{
  "lexicon": 1,
  "id": "com.decodingus.atmosphere.haplogroupReconciliation",
  "defs": {
    "main": {
      "type": "record",
      "description": "Reconciliation of haplogroup calls across multiple sequencing runs for a single biosample.",
      "key": "tid",
      "record": {
        "type": "object",
        "required": [
          "meta",
          "atUri",
          "biosampleRef",
          "dnaType",
          "status",
          "runCalls"
        ],
        "properties": {
          "atUri": {
            "type": "string",
            "description": "The AT URI of this reconciliation record."
          },
          "meta": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#recordMeta"
          },
          "biosampleRef": {
            "type": "string",
            "description": "AT URI of the parent biosample record."
          },
          "dnaType": {
            "type": "string",
            "description": "Whether this reconciliation is for Y-DNA or MT-DNA.",
            "knownValues": [
              "Y_DNA",
              "MT_DNA"
            ]
          },
          "status": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#reconciliationStatus",
            "description": "Summary reconciliation status."
          },
          "runCalls": {
            "type": "array",
            "description": "Individual haplogroup calls from each run.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#runHaplogroupCall"
            },
            "minItems": 1
          },
          "snpConflicts": {
            "type": "array",
            "description": "List of SNP-level conflicts between runs.",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#snpConflict"
            }
          },
          "heteroplasmyObservations": {
            "type": "array",
            "description": "Heteroplasmy observations (mtDNA only).",
            "items": {
              "type": "ref",
              "ref": "com.decodingus.atmosphere.defs#heteroplasmyObservation"
            }
          },
          "identityVerification": {
            "type": "ref",
            "ref": "com.decodingus.atmosphere.defs#identityVerification",
            "description": "Identity verification metrics if multiple runs were compared."
          },
          "lastReconciliationAt": {
            "type": "string",
            "format": "datetime",
            "description": "When reconciliation was last performed."
          },
          "manualOverride": {
            "type": "object",
            "description": "If a user manually overrode the consensus.",
            "properties": {
              "overriddenHaplogroup": {
                "type": "string",
                "description": "The user-specified haplogroup."
              },
              "reason": {
                "type": "string",
                "description": "Reason for the override."
              },
              "overriddenAt": {
                "type": "string",
                "format": "datetime"
              },
              "overriddenBy": {
                "type": "string",
                "description": "DID of the user who made the override."
              }
            }
          },
          "auditLog": {
            "type": "array",
            "description": "History of reconciliation decisions.",
            "items": {
              "type": "ref",
              "ref": "#auditEntry"
            }
          }
        }
      }
    },
    "auditEntry": {
      "type": "object",
      "description": "An entry in the reconciliation audit log.",
      "required": [
        "timestamp",
        "action"
      ],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "datetime"
        },
        "action": {
          "type": "string",
          "description": "Action performed.",
          "knownValues": [
            "INITIAL_RECONCILIATION",
            "RUN_ADDED",
            "RUN_REMOVED",
            "MANUAL_OVERRIDE",
            "CONFLICT_RESOLVED",
            "RECOMPUTED"
          ]
        },
        "previousConsensus": {
          "type": "string",
          "description": "Previous consensus haplogroup before this action."
        },
        "newConsensus": {
          "type": "string",
          "description": "New consensus haplogroup after this action."
        },
        "runRef": {
          "type": "string",
          "description": "AT URI of run involved (for RUN_ADDED/RUN_REMOVED)."
        },
        "notes": {
          "type": "string",
          "description": "Additional notes about this action."
        }
      }
    }
  }
}
```

---

## Record Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 WORKSPACE                                        â”‚
â”‚  at://did:plc:user/com.decodingus.atmosphere.workspace/tid                      â”‚
â”‚                                                                                  â”‚
â”‚  sampleRefs: [...]  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  projectRefs: [...] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             BIOSAMPLE               â”‚  â”‚              PROJECT                â”‚
â”‚  at://did/collection/tid            â”‚  â”‚  at://did/collection/tid            â”‚
â”‚                                     â”‚  â”‚                                     â”‚
â”‚  haplogroups: { yDna, mtDna }       â”‚  â”‚  projectName, administrator         â”‚
â”‚  sequenceRunRefs: [...] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚  memberRefs: [...] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  genotypeRefs: [...] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚                                     â”‚
â”‚  populationBreakdownRef â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚                                     â”‚
â”‚  strProfileRef â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚         â”‚         â”‚
          â”‚         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚         â”‚                                           â–¼
          â”‚         â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚         â”‚                            â”‚     POPULATION BREAKDOWN        â”‚
          â”‚         â”‚                            â”‚  ancestry components [...]      â”‚
          â”‚         â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚         â”‚
          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                                     â–¼
          â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                      â”‚           GENOTYPE              â”‚
          â”‚                                      â”‚  chipType, provider, snpCount   â”‚
          â”‚                                      â”‚  files: [...]                   â”‚
          â”‚                                      â”‚  imputationRef â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”
          â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â–¼                                                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SEQUENCE RUN            â”‚                           â”‚          IMPUTATION             â”‚
â”‚  platformName, instrumentId     â”‚                           â”‚  referencePanel, imputedCount   â”‚
â”‚  files: [...]                   â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  alignmentRefs: [...] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚                           â–¼
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚         â”‚           ALIGNMENT             â”‚
          â”‚         â”‚  referenceBuild, aligner        â”‚
          â”‚         â”‚  files: [...], metrics: {...}   â”‚
          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    INSTRUMENT OBSERVATION       â”‚
                         â”‚  instrumentId, labName          â”‚
                         â”‚  confidence: KNOWN|INFERRED     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              STR SUBSYSTEM                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  BIOSAMPLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º STR PROFILE                                              â”‚
â”‚                         markers: [{ marker, value }]                             â”‚
â”‚                         panels: [Y37, Y111, ...]                                â”‚
â”‚                                                                                  â”‚
â”‚  HAPLOGROUP NODE â”€â”€â”€â”€â–º ANCESTRAL STR                                            â”‚
â”‚                         ancestralMarkers: [{ marker, value, confidence }]       â”‚
â”‚                         branchMutations: [{ from, to }]                         â”‚
â”‚                         tmrcaEstimate: { ybp, confidence }                      â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RECONCILIATION SUBSYSTEM                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  BIOSAMPLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º HAPLOGROUP RECONCILIATION (Y-DNA)                        â”‚
â”‚             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º HAPLOGROUP RECONCILIATION (MT-DNA)                       â”‚
â”‚                                                                                  â”‚
â”‚  RECONCILIATION â”€â”€â”€â”€â”€â–º status: { compatibilityLevel, consensusHaplogroup,       â”‚
â”‚                                  branchCompatibilityScore, snpConcordance }     â”‚
â”‚                  â”€â”€â”€â”€â”€â–º runCalls: [{ runRef, haplogroup, confidence, tech }]    â”‚
â”‚                  â”€â”€â”€â”€â”€â–º snpConflicts: [{ position, snpName, calls, resolution }]â”‚
â”‚                  â”€â”€â”€â”€â”€â–º heteroplasmyObservations: [{ pos, majorAllele, VAF }]   â”‚
â”‚                  â”€â”€â”€â”€â”€â–º identityVerification: { kinship, fingerprint, yStr }    â”‚
â”‚                  â”€â”€â”€â”€â”€â–º auditLog: [{ timestamp, action, consensus changes }]    â”‚
â”‚                                                                                  â”‚
â”‚  Compatibility Levels:                                                          â”‚
â”‚    COMPATIBLE        - Same branch, different depths (Run A: R-BY18291,         â”‚
â”‚                        Run B: R-CTS4466 - both valid, accept deepest)           â”‚
â”‚    MINOR_DIVERGENCE  - Tip-level differences, sibling terminal branches         â”‚
â”‚    MAJOR_DIVERGENCE  - Branch-level split (e.g., R-DF13 children diverge)       â”‚
â”‚    INCOMPATIBLE      - Different individuals (R1b vs I2a)                       â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            MATCHING SUBSYSTEM                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  BIOSAMPLE â—„â”€â”€â”€â”€â”€ MATCH CONSENT                                                 â”‚
â”‚      â”‚              (enables matching)                                           â”‚
â”‚      â”‚                                                                          â”‚
â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º MATCH LIST                                                   â”‚
â”‚      â”‚              matches: [{ biosampleRef, sharedCm, segments }]             â”‚
â”‚      â”‚                                                                          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º MATCH REQUEST â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                     (from â†’ to, status: PENDING|ACCEPTED)                  â”‚    â”‚
â”‚                                                    â”‚                       â”‚    â”‚
â”‚                                                    â””â”€â”€â”€â–º OTHER BIOSAMPLE â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Integration Strategy

In the "Atmosphere" model, this Lexicon defines the data structures for decentralized, user-owned genomic records:

1. **MVP (Current):** The BGS Node (Rust) constructs a JSON payload matching the `ExternalBiosampleRequest` (a
   simplified subset of this Lexicon) and pushes it to `decodingus` via REST.
2. **Phase 2 (Hybrid - Kafka):** The BGS Node uses this Lexicon structure (or a derived internal representation) to send
   messages to Kafka. `decodingus` consumes from Kafka and processes a compatible subset.
3. **Phase 3 (Full Atmosphere - AppView):**
    * The Researcher's Edge App (Java) or the BGS Node (authorized by the user) constructs records fully compliant with
      this Lexicon.
    * These records are written directly to the User's PDS.
    * `decodingus` (acting as an AppView) subscribes to the ATP Firehose, ingesting these records and indexing them.

## Mapping to `decodingus` Backend (Phase 3 Considerations)

To fully leverage this Lexicon, `decodingus` will need to evolve its internal data model and services:

* **`Biosample`:** Fields like `description`, `centerName`, `sex`, `sampleAccession`, `donorIdentifier` map directly.
  The `meta.createdAt` becomes the creation timestamp.
* **`SequenceLibrary` â†’ `SequenceRun`:** Now a separate record. `platformName`, `instrumentModel`, `testType`,
  `libraryLayout`, `totalReads`, `readLength`, `meanInsertSize`.
* **`SequenceFile`:** `fileInfo` maps directly (`fileName`, `fileSizeBytes`, `fileFormat`, `checksum`, `location`).
* **`Alignment` (New Entity):** `alignment` is now a first-class record requiring new tables/models to store
  `referenceBuild`, `aligner`, `variantCaller`, and the associated `files`.
* **`AlignmentMetrics`:** Stored as part of the `alignment` record, with detailed QC statistics.
* **`Haplogroups` (Enhanced):** The detailed `haplogroupResult` (score, SNPs, lineage path) can replace or enrich our
  existing `BiosampleOriginalHaplogroup` model.
* **`Genotype` (New Entity):** Maps to new `genotype_data` table for chip/array results.
* **`Imputation` (New Entity):** Maps to new `imputation_result` table.
* **`PopulationBreakdown` (New Entity):** Maps to existing `ancestry_analysis` with enhanced population components.
* **`MatchConsent`/`MatchList`/`MatchRequest`:** Map to IBD matching system tables.
* **`InstrumentObservation`:** Maps to `instrument_observation` table for lab inference consensus.
* **`Project`:** Requires new tables (`projects`) with AT URI references to member biosamples.
* **`Workspace`:** A PDS-level container; we index its `sampleRefs` and `projectRefs` but may not store it directly.

---

## Lifecycle Management (AppView Logic)

As an AppView, `decodingus` subscribes to the AT Protocol Firehose to maintain a synchronized state of the genomic
network.

### 1. The Firehose Event Stream

We listen for `com.atproto.sync.subscribeRepos` events containing operations for these collections:

**Core Records:**

- `com.decodingus.atmosphere.biosample`
- `com.decodingus.atmosphere.sequencerun`
- `com.decodingus.atmosphere.alignment`
- `com.decodingus.atmosphere.project`
- `com.decodingus.atmosphere.workspace`

**Future Scope Records:**

- `com.decodingus.atmosphere.genotype`
- `com.decodingus.atmosphere.imputation`
- `com.decodingus.atmosphere.populationBreakdown`
- `com.decodingus.atmosphere.instrumentObservation`
- `com.decodingus.atmosphere.matchConsent`
- `com.decodingus.atmosphere.matchList`
- `com.decodingus.atmosphere.matchRequest`
- `com.decodingus.atmosphere.strProfile`
- `com.decodingus.atmosphere.haplogroupAncestralStr`

### 2. Event Handling Strategy

#### Biosample Events

| Event      | Description                      | DecodingUs Logic                                                                                                                                                                                                                                                                                                                                      |
|:-----------|:---------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | User creates a new biosample     | 1. Extract `citizenDid` and record body.<br>2. Create `biosample` row with donor metadata and haplogroups (computed locally in Navigator Workbench).<br>3. Store `at_uri` and `at_cid`.<br>4. If `haplogroups` contains `privateVariants`, add to branch discovery consensus pool.<br>5. `sequenceRunRefs` and `genotypeRefs` may be empty initially. |
| **Update** | User modifies biosample metadata | 1. Lookup by `at_uri`.<br>2. Compare `at_cid` for version conflict.<br>3. Check `meta.lastModifiedField` for targeted update.<br>4. Update only changed fields (description, haplogroups, etc.).<br>5. Update `at_cid` and `meta.version`.                                                                                                            |
| **Delete** | User removes biosample           | 1. Lookup by `at_uri`.<br>2. Soft-delete biosample.<br>3. Mark related sequence runs, genotypes, and alignments as orphaned (do not delete).<br>4. Revoke any active `matchConsent`.                                                                                                                                                                  |

#### Sequence Run Events

| Event      | Description                    | DecodingUs Logic                                                                                                                                                                                                                                                      |
|:-----------|:-------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | User adds a new sequencing run | 1. Resolve `biosampleRef` to internal biosample ID.<br>2. Create `sequence_libraries` row.<br>3. Store `at_uri` and `at_cid`.<br>4. If `instrumentId` present, trigger lab inference check.<br>5. Update parent biosample's `sequenceRunRefs` if not already present. |
| **Update** | User updates run metadata      | 1. Lookup by `at_uri`.<br>2. Update only changed fields (files, metrics).<br>3. Parent biosample unchanged.                                                                                                                                                           |
| **Delete** | User removes a run             | 1. Soft-delete sequence run.<br>2. Mark child alignments as orphaned.<br>3. Remove from parent's `sequenceRunRefs`.                                                                                                                                                   |

#### Alignment Events

| Event      | Description                   | DecodingUs Logic                                                                                                                        |
|:-----------|:------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | User adds alignment results   | 1. Resolve `sequenceRunRef` to internal sequence run ID.<br>2. Create `alignments` row with metrics.<br>3. Store `at_uri` and `at_cid`. |
| **Update** | User updates metrics or files | 1. Lookup by `at_uri`.<br>2. Update metrics or file references.<br>3. Parent records unchanged (key benefit).                           |
| **Delete** | User removes alignment        | 1. Soft-delete alignment only.<br>2. Parent sequence run unchanged.                                                                     |

#### Genotype Events (Future)

| Event      | Description                    | DecodingUs Logic                                                                                                                                                                                                                                                                                                                            |
|:-----------|:-------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | User adds genotype data        | 1. Resolve `biosampleRef` to internal biosample ID.<br>2. Create `genotype_data` row with metadata (file info, chip type).<br>3. Haplogroup calling performed locally in Navigator Workbench; results sync via biosample haplogroups.<br>4. IBD analysis performed locally; only `matchConsent` determines visibility in potential matches. |
| **Update** | User updates genotype metadata | 1. Lookup by `at_uri`.<br>2. Update chip info, file metadata.<br>3. If haplogroup results changed, biosample update follows separately.                                                                                                                                                                                                     |
| **Delete** | User removes genotype          | 1. Soft-delete genotype.<br>2. Orphan any dependent imputation records.<br>3. Remove from IBD matching index.                                                                                                                                                                                                                               |

#### Instrument Observation Events (Future)

| Event      | Description                  | DecodingUs Logic                                                                                                                                                                                                                |
|:-----------|:-----------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | User submits lab observation | 1. Record observation in `instrument_observation` table.<br>2. Aggregate with existing observations for same `instrumentId`.<br>3. Update proposal if threshold reached.<br>4. Flag for curator review if confidence increases. |
| **Update** | User corrects observation    | 1. Update observation.<br>2. Recalculate consensus.                                                                                                                                                                             |
| **Delete** | User retracts observation    | 1. Remove observation.<br>2. Recalculate consensus.                                                                                                                                                                             |

#### Match Consent Events (Future)

| Event      | Description             | DecodingUs Logic                                                                                                                                                                                    |
|:-----------|:------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | User opts into matching | 1. Create consent record.<br>2. Include biosample in potential match discovery (matching computed locally, candidates identified network-wide).<br>3. Set visibility level based on `consentLevel`. |
| **Update** | User modifies consent   | 1. Update consent parameters.<br>2. Adjust match visibility accordingly.<br>3. May need to reprocess matches.                                                                                       |
| **Delete** | User revokes consent    | 1. Remove from active matching pool.<br>2. Remove matches from other users' match lists.<br>3. Preserve audit trail.                                                                                |

#### Match List Events (Future)

| Event      | Description                     | DecodingUs Logic                                                                                                                                        |
|:-----------|:--------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | AppView publishes match results | 1. Validate this is from authorized AppView.<br>2. Store match data for citizen access.<br>3. This is typically written BY DecodingUs, not by citizens. |
| **Update** | AppView updates matches         | 1. Replace match list with new version.<br>2. Notify citizen of significant changes.                                                                    |

#### STR Profile Events

| Event      | Description              | DecodingUs Logic                                                                                                                                                                                                               |
|:-----------|:-------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | User adds STR profile    | 1. Resolve `biosampleRef` to internal biosample ID.<br>2. Create `str_profiles` row.<br>3. Parse and validate marker values (handle simple, multi-copy, complex).<br>4. Update biosample's `strProfileRef` if not already set. |
| **Update** | User updates STR data    | 1. Lookup by `at_uri`.<br>2. Update marker values (e.g., adding more panels).<br>3. Trigger recomputation of group project comparisons if member.                                                                              |
| **Delete** | User removes STR profile | 1. Soft-delete profile.<br>2. Remove from project STR analyses.                                                                                                                                                                |

#### Haplogroup Ancestral STR Events (Future)

| Event      | Description                       | DecodingUs Logic                                                                                                                                                     |
|:-----------|:----------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Create** | AppView computes ancestral state  | 1. Validate this is from authorized AppView.<br>2. Store ancestral reconstruction for haplogroup node.<br>3. This is computed BY DecodingUs from descendant samples. |
| **Update** | AppView recomputes after new data | 1. Replace with new reconstruction.<br>2. Update confidence scores and TMRCA estimates.                                                                              |

### 3. Schema Requirements

To support robust syncing, internal tables require these tracking fields:

| Field          | Type           | Description                                       |
|:---------------|:---------------|:--------------------------------------------------|
| `at_uri`       | String, Unique | Canonical decentralized address for lookups       |
| `at_cid`       | String         | Content identifier for version/conflict detection |
| `at_version`   | Integer        | Mirrors `meta.version` for optimistic locking     |
| `at_status`    | Enum           | `active`, `orphaned`, `deleted`                   |
| `at_synced_at` | Timestamp      | Last successful sync from firehose                |

### 4. Orphan Handling

When a parent record is deleted but children exist:

1. Children are marked `orphaned` (not deleted)
2. Orphaned records are hidden from normal queries
3. If parent is recreated with same `at_uri`, children can be reattached
4. Periodic cleanup job can hard-delete orphans after retention period

### 5. Conflict Resolution

When processing firehose events:

1. Compare incoming `at_cid` with stored value
2. If different, compare `meta.version` numbers
3. Higher version wins; on tie, later timestamp wins
4. Log conflicts for manual review if needed

---

## Example Mock Data

### Biosample Record

```json
{
  "$type": "com.decodingus.atmosphere.biosample",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "meta": {
    "version": 2,
    "createdAt": "2025-12-05T14:30:00Z",
    "updatedAt": "2025-12-06T09:15:00Z",
    "lastModifiedField": "haplogroups.yDna"
  },
  "sampleAccession": "BGS-UUID-98765-XYZ",
  "donorIdentifier": "Subject-001",
  "citizenDid": "did:plc:alice123",
  "description": "Deep WGS of Proband from Smith Family Trio",
  "centerName": "DecodingUs Reference Lab",
  "sex": "Male",
  "haplogroups": {
    "yDna": {
      "haplogroupName": "R-M269",
      "score": 0.998,
      "matchingSnps": 145,
      "mismatchingSnps": 2,
      "ancestralMatches": 3000,
      "treeDepth": 25,
      "lineagePath": [
        "R",
        "R1",
        "R1b",
        "R-M269"
      ],
      "privateVariants": {
        "variants": [
          {
            "contigAccession": "NC_000024.10",
            "position": 12345678,
            "referenceAllele": "C",
            "alternateAllele": "T",
            "genotype": "T",
            "quality": 99.5,
            "depth": 45
          }
        ],
        "analysisVersion": "decodingus-1.2.0",
        "referenceTree": "ISOGG-2024"
      }
    },
    "mtDna": {
      "haplogroupName": "H1a",
      "score": 0.995,
      "matchingSnps": 42,
      "mismatchingSnps": 0,
      "ancestralMatches": 800,
      "treeDepth": 18,
      "lineagePath": [
        "L3",
        "N",
        "R",
        "HV",
        "H",
        "H1",
        "H1a"
      ]
    }
  },
  "sequenceRunRefs": [
    "at://did:plc:alice123/com.decodingus.atmosphere.sequencerun/3jui7q2ly"
  ],
  "genotypeRefs": [],
  "populationBreakdownRef": "at://did:plc:alice123/com.decodingus.atmosphere.populationBreakdown/3jui7q2m1"
}
```

### Sequence Run Record

```json
{
  "$type": "com.decodingus.atmosphere.sequencerun",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.sequencerun/3jui7q2ly",
  "meta": {
    "version": 1,
    "createdAt": "2025-12-05T14:35:00Z"
  },
  "biosampleRef": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "platformName": "ILLUMINA",
  "instrumentModel": "NovaSeq 6000",
  "instrumentId": "A00123",
  "testType": "WGS",
  "libraryLayout": "PAIRED",
  "totalReads": 850000000,
  "readLength": 150,
  "meanInsertSize": 450.0,
  "flowcellId": "HXXYYZZAA",
  "runDate": "2025-11-20T00:00:00Z",
  "files": [
    {
      "fileName": "Sample001_R1.fastq.gz",
      "fileSizeBytes": 15000000000,
      "fileFormat": "FASTQ",
      "checksum": "sha256-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "checksumAlgorithm": "SHA-256",
      "location": "s3://lab-data-bucket/raw/Sample001_R1.fastq.gz"
    }
  ],
  "alignmentRefs": [
    "at://did:plc:alice123/com.decodingus.atmosphere.alignment/3jui7q2lz"
  ]
}
```

### Genotype Record (In Development)

```json
{
  "$type": "com.decodingus.atmosphere.genotype",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.genotype/3jui7q3aa",
  "meta": {
    "version": 1,
    "createdAt": "2025-12-08T10:00:00Z"
  },
  "biosampleRef": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "testTypeCode": "ARRAY_23ANDME_V5",
  "provider": "23andMe",
  "chipVersion": "v5",
  "totalMarkersCalled": 638542,
  "totalMarkersPossible": 640000,
  "noCallRate": 0.0023,
  "yMarkersCalled": 1847,
  "yMarkersTotal": 2000,
  "mtMarkersCalled": 2891,
  "mtMarkersTotal": 3000,
  "autosomalMarkersCalled": 612453,
  "hetRate": 0.31,
  "testDate": "2024-06-15T00:00:00Z",
  "processedAt": "2025-12-08T10:00:00Z",
  "buildVersion": "GRCh37",
  "sourceFileHash": "sha256-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
  "files": [
    {
      "fileName": "23andme_raw_data.txt",
      "fileSizeBytes": 25000000,
      "fileFormat": "23ANDME",
      "checksum": "sha256-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "checksumAlgorithm": "SHA-256",
      "location": "file:///Users/alice/Downloads/23andme_raw_data.txt"
    }
  ],
  "derivedHaplogroups": {
    "yDna": {
      "haplogroupName": "R-M269",
      "score": 0.85,
      "matchingSnps": 45,
      "mismatchingSnps": 2,
      "treeDepth": 8,
      "lineagePath": [
        "R",
        "R1",
        "R1b",
        "R-M269"
      ]
    },
    "mtDna": {
      "haplogroupName": "H1a",
      "score": 0.92,
      "matchingSnps": 28,
      "mismatchingSnps": 0,
      "treeDepth": 4,
      "lineagePath": [
        "H",
        "H1",
        "H1a"
      ]
    }
  },
  "populationBreakdownRef": "at://did:plc:alice123/com.decodingus.atmosphere.populationBreakdown/3jui7q2m1"
}
```

### Match Consent Record (Future)

```json
{
  "$type": "com.decodingus.atmosphere.matchConsent",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.matchConsent/3jui7q3bb",
  "meta": {
    "version": 1,
    "createdAt": "2025-12-01T11:00:00Z"
  },
  "biosampleRef": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "consentLevel": "FULL",
  "allowedMatchTypes": [
    "IBD",
    "Y_STR",
    "AUTOSOMAL"
  ],
  "minimumSegmentCm": 7.0,
  "shareContactInfo": true,
  "consentedAt": "2025-12-01T11:00:00Z"
}
```

### Match List Record (Future)

```json
{
  "$type": "com.decodingus.atmosphere.matchList",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.matchList/3jui7q3cc",
  "meta": {
    "version": 5,
    "createdAt": "2025-12-01T12:00:00Z",
    "updatedAt": "2025-12-06T08:00:00Z"
  },
  "biosampleRef": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "matchCount": 127,
  "lastCalculatedAt": "2025-12-06T08:00:00Z",
  "matches": [
    {
      "matchedBiosampleRef": "at://did:plc:bob456/com.decodingus.atmosphere.biosample/3abc123",
      "matchedCitizenDid": "did:plc:bob456",
      "relationshipEstimate": "2ND_COUSIN",
      "totalSharedCm": 215.5,
      "longestSegmentCm": 45.2,
      "segmentCount": 8,
      "matchedAt": "2025-12-02T14:30:00Z",
      "sharedSegments": [
        {
          "chromosome": "7",
          "startPosition": 50000000,
          "endPosition": 75000000,
          "lengthCm": 45.2,
          "snpCount": 12500,
          "isHalfIdentical": true
        }
      ]
    }
  ]
}
```

### Instrument Observation Record (Future)

```json
{
  "$type": "com.decodingus.atmosphere.instrumentObservation",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.instrumentObservation/3jui7q3dd",
  "meta": {
    "version": 1,
    "createdAt": "2025-12-05T14:40:00Z"
  },
  "instrumentId": "A00123",
  "labName": "Nebula Genomics",
  "biosampleRef": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "sequenceRunRef": "at://did:plc:alice123/com.decodingus.atmosphere.sequencerun/3jui7q2ly",
  "platform": "ILLUMINA",
  "instrumentModel": "NovaSeq 6000",
  "flowcellId": "HXXYYZZAA",
  "runDate": "2025-11-20T00:00:00Z",
  "confidence": "KNOWN"
}
```

### Population Breakdown Record (In Development)

```json
{
  "$type": "com.decodingus.atmosphere.populationBreakdown",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.populationBreakdown/3jui7q2m1",
  "meta": {
    "version": 1,
    "createdAt": "2025-12-08T16:00:00Z"
  },
  "biosampleRef": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "analysisMethod": "PCA_PROJECTION_GMM",
  "panelType": "aims",
  "referencePopulations": "1000G_HGDP_v1",
  "snpsAnalyzed": 5000,
  "snpsWithGenotype": 4823,
  "snpsMissing": 177,
  "confidenceLevel": 0.92,
  "components": [
    {
      "populationCode": "CEU",
      "populationName": "Northwestern European",
      "superPopulation": "European",
      "percentage": 48.2,
      "confidenceInterval": {
        "lower": 45.1,
        "upper": 51.3
      },
      "rank": 1
    },
    {
      "populationCode": "GBR",
      "populationName": "British",
      "superPopulation": "European",
      "percentage": 22.5,
      "confidenceInterval": {
        "lower": 19.8,
        "upper": 25.2
      },
      "rank": 2
    },
    {
      "populationCode": "IBS",
      "populationName": "Iberian",
      "superPopulation": "European",
      "percentage": 15.3,
      "confidenceInterval": {
        "lower": 12.1,
        "upper": 18.5
      },
      "rank": 3
    },
    {
      "populationCode": "FIN",
      "populationName": "Finnish",
      "superPopulation": "European",
      "percentage": 8.7,
      "confidenceInterval": {
        "lower": 6.2,
        "upper": 11.2
      },
      "rank": 4
    },
    {
      "populationCode": "YRI",
      "populationName": "Yoruba",
      "superPopulation": "African",
      "percentage": 3.2,
      "confidenceInterval": {
        "lower": 1.5,
        "upper": 4.9
      },
      "rank": 5
    }
  ],
  "superPopulationSummary": [
    {
      "superPopulation": "European",
      "percentage": 94.7,
      "populations": [
        "CEU",
        "GBR",
        "IBS",
        "FIN",
        "TSI"
      ]
    },
    {
      "superPopulation": "African",
      "percentage": 3.2,
      "populations": [
        "YRI",
        "LWK",
        "ESN",
        "MSL",
        "GWD"
      ]
    }
  ],
  "pcaCoordinates": [
    0.0234,
    -0.0156,
    0.0089
  ],
  "analysisDate": "2025-12-08T16:00:00Z",
  "pipelineVersion": "1.0.0",
  "referenceVersion": "v1"
}
```

### STR Profile Record

```json
{
  "$type": "com.decodingus.atmosphere.strProfile",
  "atUri": "at://did:plc:alice123/com.decodingus.atmosphere.strProfile/3jui7q3ee",
  "meta": {
    "version": 1,
    "createdAt": "2025-12-05T15:30:00Z"
  },
  "biosampleRef": "at://did:plc:alice123/com.decodingus.atmosphere.biosample/3jui7q2lx",
  "sequenceRunRef": "at://did:plc:alice123/com.decodingus.atmosphere.sequencerun/3jui7q2ly",
  "panels": [
    {
      "panelName": "Y111",
      "markerCount": 111,
      "provider": "WGS_DERIVED",
      "testDate": "2025-12-05T15:30:00Z"
    }
  ],
  "markers": [
    {
      "marker": "DYS393",
      "value": {
        "type": "simple",
        "repeats": 13
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYS390",
      "value": {
        "type": "simple",
        "repeats": 24
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYS385a",
      "value": {
        "type": "multiCopy",
        "copies": [
          11,
          14
        ]
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYS385b",
      "value": {
        "type": "multiCopy",
        "copies": [
          11,
          14
        ]
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYF399X",
      "value": {
        "type": "complex",
        "alleles": [
          {
            "repeats": 22,
            "count": 1,
            "designation": "t"
          },
          {
            "repeats": 25,
            "count": 2,
            "designation": "c"
          },
          {
            "repeats": 26.1,
            "count": 1,
            "designation": "t"
          }
        ],
        "rawNotation": "22t-25c-26.1t"
      },
      "panel": "Y500",
      "quality": "HIGH"
    },
    {
      "marker": "DYS19",
      "value": {
        "type": "simple",
        "repeats": 14
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYS391",
      "value": {
        "type": "simple",
        "repeats": 11
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYS439",
      "value": {
        "type": "simple",
        "repeats": 12
      },
      "panel": "Y25",
      "quality": "HIGH"
    },
    {
      "marker": "DYS389i",
      "value": {
        "type": "simple",
        "repeats": 13
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYS389ii",
      "value": {
        "type": "simple",
        "repeats": 29
      },
      "panel": "Y12",
      "quality": "HIGH"
    },
    {
      "marker": "DYS458",
      "value": {
        "type": "simple",
        "repeats": 17
      },
      "panel": "Y37",
      "quality": "HIGH"
    },
    {
      "marker": "DYS459a",
      "value": {
        "type": "multiCopy",
        "copies": [
          9,
          10
        ]
      },
      "panel": "Y37",
      "quality": "HIGH"
    }
  ],
  "totalMarkers": 111,
  "source": "WGS_DERIVED",
  "derivationMethod": "HIPSTR"
}
```

### Haplogroup Ancestral STR Record (Future)

```json
{
  "$type": "com.decodingus.atmosphere.haplogroupAncestralStr",
  "atUri": "at://did:plc:decodingus-appview/com.decodingus.atmosphere.haplogroupAncestralStr/r-m269",
  "meta": {
    "version": 12,
    "createdAt": "2025-01-15T00:00:00Z",
    "updatedAt": "2025-12-05T18:00:00Z"
  },
  "haplogroup": "R-M269",
  "haplogroupTreeRef": "decodingus-ydna-tree-2025-12",
  "parentHaplogroup": "R-L23",
  "ancestralMarkers": [
    {
      "marker": "DYS393",
      "ancestralValue": {
        "type": "simple",
        "repeats": 13
      },
      "confidence": 0.98,
      "supportingSamples": 4521,
      "variance": 0.15,
      "method": "PARSIMONY"
    },
    {
      "marker": "DYS390",
      "ancestralValue": {
        "type": "simple",
        "repeats": 24
      },
      "confidence": 0.95,
      "supportingSamples": 4489,
      "variance": 0.42,
      "method": "PARSIMONY"
    },
    {
      "marker": "DYS385a",
      "ancestralValue": {
        "type": "multiCopy",
        "copies": [
          11,
          14
        ]
      },
      "confidence": 0.91,
      "supportingSamples": 4320,
      "variance": 0.68,
      "method": "PARSIMONY"
    },
    {
      "marker": "DYS19",
      "ancestralValue": {
        "type": "simple",
        "repeats": 14
      },
      "confidence": 0.97,
      "supportingSamples": 4510,
      "variance": 0.22,
      "method": "PARSIMONY"
    }
  ],
  "sampleCount": 4521,
  "computedAt": "2025-12-05T18:00:00Z",
  "method": "PARSIMONY",
  "softwareVersion": "decodingus-str-reconstruction-1.0.0",
  "mutationRateModel": "BALLANTYNE_2010",
  "tmrcaEstimate": {
    "yearsBeforePresent": 4800,
    "confidenceInterval": {
      "lower": 4200,
      "upper": 5600
    },
    "generationTime": 31
  },
  "branchMutations": [
    {
      "marker": "DYS458",
      "fromValue": {
        "type": "simple",
        "repeats": 16
      },
      "toValue": {
        "type": "simple",
        "repeats": 17
      },
      "stepChange": 1,
      "confidence": 0.82
    }
  ]
}
```

---

## CRUD Event Flow Examples

### Example 1: Adding a New WGS Result to Existing Biosample

**Scenario:** User already has a biosample with one 30x WGS. They add a new 60x deep WGS from a different platform.

**Local Analysis Flow (in Navigator Workbench):**

1. User aligns new PacBio data locally (GRCh38)
2. Navigator computes coverage metrics, haplogroups locally
3. Navigator syncs metadata to PDS

**Firehose Events (metadata only):**

1. **Create `sequencerun`** (metadata for new run with PacBio data)
    - `biosampleRef` points to existing biosample
    - `instrumentId` triggers lab lookup
    - DecodingUs: Creates new `sequence_libraries` metadata row (no raw data)

2. **Update `biosample`** (optional, to add reference)
    - `sequenceRunRefs` now includes new run's AT URI
    - `meta.version` incremented
    - `meta.lastModifiedField`: "sequenceRunRefs"
    - DecodingUs: Updates only the refs array, no other changes

3. **Create `alignment`** (metadata for GRCh38 alignment)
    - `sequenceRunRef` points to new run
    - Contains coverage metrics computed locally
    - DecodingUs: Creates new `alignments` metadata row (no BAM/CRAM content)

**Result:** Three small, targeted metadata operations. Raw data stays local.

### Example 2: Adding Genotype Data for IBD Matching (Future)

**Scenario:** User imports their 23andMe data in Navigator Workbench and opts into matching.

**Local Analysis Flow (in Navigator Workbench):**

1. User imports 23andMe file locally
2. Navigator computes haplogroups, ancestry, IBD segments locally
3. Navigator syncs metadata to PDS (haplogroups, ancestry percentages, consent)

**Firehose Events (metadata only):**

1. **Create `genotype`**
    - Contains chip details and file metadata (not the actual file)
    - DecodingUs: Creates `genotype_data` row with metadata only

2. **Create `matchConsent`**
    - User opts into FULL matching
    - DecodingUs: Includes biosample in potential match discovery

3. **AppView creates `potentialMatchList`**
    - Based on consented biosamples across network
    - DecodingUs identifies candidates; user explores matches locally in Workbench
    - Both parties must agree before `confirmedMatch` is stamped

**Result:** User sees potential matches; actual comparison done locally.

### Example 3: Contributing Lab Observation (Future)

**Scenario:** User's sequence run contains instrument ID not in database.

**Firehose Events:**

1. **Create `instrumentObservation`**
    - User provides lab name with KNOWN confidence
    - DecodingUs: Records observation, aggregates with others
    - If threshold reached, proposal created for curator

**Result:** Crowdsourced lab database improves.

### Example 4: Haplogroup Discovery with Private Variants

**Scenario:** User's haplogroup result contains novel variants.

**Firehose Events:**

1. **Create/Update `biosample`**
    - `haplogroups.yDna.privateVariants` contains novel variant calls
    - DecodingUs: Extracts private variants
    - ProposalEngine: Creates or updates ProposedBranch
    - If consensus reached, curator notified

**Result:** Novel haplogroup branch discovered from network-wide observations.

---

## Future Scope Summary

| Record Type                 | Planning Document                           | Purpose                                                     |
|:----------------------------|:--------------------------------------------|:------------------------------------------------------------|
| `genotype`                  | multi-test-type-roadmap.md                  | Chip/array data support (ðŸš§ In Development)                 |
| `imputation`                | multi-test-type-roadmap.md                  | Imputed genotype results                                    |
| `populationBreakdown`       | ibd-matching-system.md, AncestryAnalysis.md | Ancestry composition (ðŸš§ In Development)                    |
| `matchConsent`              | ibd-matching-system.md                      | IBD matching opt-in                                         |
| `matchList`                 | ibd-matching-system.md                      | IBD match results                                           |
| `matchRequest`              | ibd-matching-system.md                      | Match contact requests                                      |
| `instrumentObservation`     | sequencer-lab-inference-system.md           | Crowdsourced lab discovery                                  |
| `privateVariants` (in defs) | haplogroup-discovery-system.md              | Novel variant tracking                                      |
| `strProfile`                | Y-DNA STR Support                           | Individual Y-STR marker data                                |
| `haplogroupAncestralStr`    | Y-DNA Tree Enhancement                      | Reconstructed ancestral STR states                          |
| `haplogroupReconciliation`  | MultiRunReconciliation.md                   | Multi-run haplogroup reconciliation and conflict resolution |
| `haplogroupUpdate`          | appview-pds-backfeed-system.md              | AppView notification of haplogroup refinement               |
| `branchDiscovery`           | appview-pds-backfeed-system.md              | AppView notification of new branch from private variants    |
| `treeVersionUpdate`         | appview-pds-backfeed-system.md              | AppView notification of haplogroup tree version change      |
| `potentialMatchList`        | appview-pds-backfeed-system.md              | Potential match candidates for user exploration             |
| `confirmedMatch`            | appview-pds-backfeed-system.md              | Stamped match when both parties agree                       |
| `syncStatus`                | appview-pds-backfeed-system.md              | Track PDS-AppView synchronization state                     |
| `updateDigest`              | appview-pds-backfeed-system.md              | Daily digest of all updates                                 |

---

## Edge Client Implementation Status

See [Edge_Client_Implementation_Status.md](Edge_Client_Implementation_Status.md) for detailed implementation status tracking Navigator Desktop against this lexicon specification (~55% complete).

---

## Changelog

| Version | Date       | Changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|:--------|:-----------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1.0     | 2025-12-05 | Initial design with CRUD-optimized record structure                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 1.1     | 2025-12-06 | Added future scope records from planning documents                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 1.2     | 2025-12-07 | Added STR profile and ancestral STR reconstruction records                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 1.3     | 2025-12-07 | Added backfeed record types for AppView-to-PDS updates                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 1.4     | 2025-12-07 | Edge computing compliance: Clarified all `files` fields store metadata only, updated CRUD examples to reflect local analysis model                                                                                                                                                                                                                                                                                                                                                     |
| 1.5     | 2025-12-08 | Added multi-run reconciliation support: `haplogroupReconciliation` record, reconciliation definitions (reconciliationStatus, runHaplogroupCall, snpConflict, heteroplasmyObservation, identityVerification), updated biosample with reconciliation refs. Added `strHaplogroupPrediction` definition for STR-based haplogroup prediction with support for Nevgen, Hapest, YHaplo, SAPP algorithms                                                                                       |
| 1.6     | 2025-12-08 | Enhanced ancestry analysis support: Updated `populationBreakdown` record with PCA projection algorithm details, two-tier panel support (AIMs/genome-wide), 33 reference populations from 1000G + HGDP/SGDP organized into 9 super-populations. Added new definitions: `superPopulationSummary`, `ancestryPanel`. Enhanced `populationComponent` with `superPopulation` and `rank` fields. Added IBD matching integration guidance. Status changed from Future Scope to In Development. |
| 1.7     | 2025-12-08 | Multi-test-type support (Phase 1): Enhanced `genotype` record with test type taxonomy codes (ARRAY_23ANDME_V5, etc.), detailed marker statistics (Y/mtDNA/autosomal counts), and derived haplogroup support. Added Edge App processing documentation. Navigator Desktop now supports parsing 23andMe, AncestryDNA, FTDNA, MyHeritage, and LivingDNA raw data exports. Status changed from Future Scope to In Development.                                                              |
| 1.8     | 2025-12-08 | Added Edge Client Implementation Status reference. Full tracking moved to dedicated document: Edge_Client_Implementation_Status.md                                                                                                                                                                                                                                                                                                                                                      |